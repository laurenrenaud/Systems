---
title: "College Town Natural Experiments"
author: "The Mary Janes"
date: "April, 2017"
output: 
html_document:
    toc: yes
    toc_depth: 3
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE)
library(readr)
library(dplyr)
library(ggplot2)
library(gridExtra)
library(tidyr)
library(splines)

# dfs for this analysis
daily_aggregate <- readr::read_csv("college_towns/daily_aggregate.csv")

daily_agg_summary <- daily_aggregate %>%
  group_by(saledate) %>%
  summarise(revenue = median(revenue, na.rm=T),
            tot_items = median(tot_items, na.rm=T),
            avg_price_peritem = median(avg_price_peritem, na.rm=T),
            perc.usable = median(perc.usable, na.rm=T),
            perc.edible = median(perc.edible, na.rm=T),
            perc.extracts = median(perc.extracts, na.rm=T),
            city = "State_Avg")

daily_aggregate_bycollegeBoolean <- readr::read_csv("college_towns/daily_aggregate_bycollegeBoolean.csv")

daily_aggregate_PullmanNoncollege <- readr::read_csv("college_towns/daily_aggregate_PullmanNoncollege.csv")

daily_aggregate_byTownType <- readr::read_csv("college_towns/daily_aggregate_byTownType.csv")

daily_aggregate_inhaltypes_byTownType <- readr::read_csv("college_towns/daily_aggregate_inhaltypes_byTownType.csv")

daily_aggregate_PullmanUrbanRestofState <- readr::read_csv("college_towns/daily_aggregate_PullmanUrbanRestofState.csv")

```


## Introduction

## General seasonality

```{r overall_seasonality}

overall_agg <- daily_aggregate %>%
  ggplot(aes(x=saledate, y=tot_items)) +
  # geom_point() +
  # different regression lines for spring, summer, and fall
  geom_smooth(data=subset(daily_aggregate, saledate >= "2016-01-01" & saledate <= "2016-05-05"),
              mapping = aes(x=saledate,y=tot_items),
              method = 'lm', formula = y~ns(x, df=3), color =  "#CC79A7") +
  geom_smooth(data=subset(daily_aggregate, saledate >= "2016-05-05" & 
                            saledate <= "2016-08-22"),
              mapping = aes(x=saledate,y=tot_items), 
              method = 'lm', formula = y~ns(x, df=3), color =  "#CC79A7") +
  geom_smooth(data=subset(daily_aggregate, saledate >= "2016-08-22"),
              mapping = aes(x=saledate,y=tot_items), 
              method = 'lm', formula = y~ns(x, df=3), color =  "#CC79A7") +
  # add lines to designate summer
  geom_vline(xintercept= as.numeric(as.Date('2016-5-6')),
             linetype="dashed", size=1, colour="darkgreen")+
  geom_vline(xintercept= as.numeric(as.Date('2016-8-22')),
             linetype="dashed", size=1, colour="darkgreen") +
  labs(title="Total Items Sold: State Aggregate",
       y = "Total Items Sold",
       x = "Date, Summer Indicated in Green Bracket")

pullman_agg <- daily_aggregate %>%
  ggplot(aes(x=saledate, y=tot_items)) +
  # geom_point() +
  # different regression lines for spring, summer, and fall
  geom_smooth(data=subset(daily_aggregate, city=="PULLMAN" & saledate >= "2016-01-01" & saledate <= "2016-05-05"),
              mapping = aes(x=saledate,y=tot_items),
              method = 'lm', formula = y~ns(x, df=3), color =  "#CC79A7") +
  geom_smooth(data=subset(daily_aggregate, city=="PULLMAN" & saledate >= "2016-05-05" & 
                            saledate <= "2016-08-22"),
              mapping = aes(x=saledate,y=tot_items), 
              method = 'lm', formula = y~ns(x, df=3), color =  "#CC79A7") +
  geom_smooth(data=subset(daily_aggregate, city=="PULLMAN" & saledate >= "2016-08-22" & saledate < "2017-01-01"),
              mapping = aes(x=saledate,y=tot_items), 
              method = 'lm', formula = y~ns(x, df=3), color =  "#CC79A7") +
  # add lines to designate summer
  geom_vline(xintercept= as.numeric(as.Date('2016-5-6')),
             linetype="dashed", size=1, colour="darkgreen")+
  geom_vline(xintercept= as.numeric(as.Date('2016-8-22')),
             linetype="dashed", size=1, colour="darkgreen") +
  labs(title="Total Items Sold: Pullman",
       y = "Total Items Sold",
       x = "Date, Summer Indicated in Green Bracket")

grid.arrange(overall_agg, pullman_agg)


daily_aggregate %>%
  ggplot(aes(x=saledate, y=tot_items)) +
  # geom_point() +
  # State aggregate
  geom_smooth(data=subset(daily_aggregate, saledate >= "2016-01-01" & saledate <= "2016-05-05"),
              mapping = aes(x=saledate,y=tot_items),
              method = 'lm', formula = y~ns(x, df=3), color =  "#CC79A7", linetype="dotted") +
  geom_smooth(data=subset(daily_aggregate, saledate >= "2016-05-05" & 
                            saledate <= "2016-08-22"),
              mapping = aes(x=saledate,y=tot_items), 
              method = 'lm', formula = y~ns(x, df=3), color =  "#CC79A7", linetype="dotted") +
  geom_smooth(data=subset(daily_aggregate, saledate >= "2016-08-22"),
              mapping = aes(x=saledate,y=tot_items), 
              method = 'lm', formula = y~ns(x, df=3), color =  "#CC79A7", linetype="dotted") +
  # just Pullman
  geom_smooth(data=subset(daily_aggregate, city=="PULLMAN" & saledate >= "2016-01-01" & saledate <= "2016-05-05"),
              mapping = aes(x=saledate,y=tot_items),
              method = 'lm', formula = y~ns(x, df=3), color =  "darkgreen") +
  geom_smooth(data=subset(daily_aggregate, city=="PULLMAN" & saledate >= "2016-05-05" & 
                            saledate <= "2016-08-22"),
              mapping = aes(x=saledate,y=tot_items), 
              method = 'lm', formula = y~ns(x, df=3), color =  "darkgreen") +
  geom_smooth(data=subset(daily_aggregate, city=="PULLMAN" & saledate >= "2016-08-22"),
              mapping = aes(x=saledate,y=tot_items), 
              method = 'lm', formula = y~ns(x, df=3), color =  "darkgreen") +
  # add lines to designate summer
  geom_vline(xintercept= as.numeric(as.Date('2016-5-6')),
             linetype="dashed", size=0.5, colour="dimgrey")+
  geom_vline(xintercept= as.numeric(as.Date('2016-8-22')),
             linetype="dashed", size=0.5, colour="dimgrey") +
  labs(title="Total Items Sold: State Dotted, Pullman Solid",
       y = "Total Items Sold",
       x = "Date, Summer Indicated in Bracket")



daily_aggregate %>%
  ggplot(aes(x=saledate, y=tot_items)) +
  # geom_point() +
  # State aggregate
  geom_smooth(data=subset(daily_aggregate, saledate >= "2016-01-01" & saledate <= "2016-05-05"),
              mapping = aes(x=saledate,y=tot_items),
              method = 'lm', formula = y~ns(x, df=2), color =  "blue3", linetype="dashed") +
  geom_smooth(data=subset(daily_aggregate, saledate >= "2016-05-05" & 
                            saledate <= "2016-08-22"),
              mapping = aes(x=saledate,y=tot_items), 
              method = 'lm', formula = y~ns(x, df=2), color =  "blue3", linetype="dashed") +
  geom_smooth(data=subset(daily_aggregate, saledate >= "2016-08-22"),
              mapping = aes(x=saledate,y=tot_items), 
              method = 'lm', formula = y~ns(x, df=2), color =  "blue3", linetype="dashed") +
  # just Pullman
  geom_smooth(data=subset(daily_aggregate, city=="PULLMAN" & saledate >= "2016-01-01" & saledate <= "2016-05-05"),
              mapping = aes(x=saledate,y=tot_items),
              method = 'lm', formula = y~ns(x, df=2), color =  "darkgreen") +
  geom_smooth(data=subset(daily_aggregate, city=="PULLMAN" & saledate >= "2016-05-05" & 
                            saledate <= "2016-08-22"),
              mapping = aes(x=saledate,y=tot_items), 
              method = 'lm', formula = y~ns(x, df=2), color =  "darkgreen") +
  geom_smooth(data=subset(daily_aggregate, city=="PULLMAN" & saledate >= "2016-08-22"),
              mapping = aes(x=saledate,y=tot_items), 
              method = 'lm', formula = y~ns(x, df=2), color =  "darkgreen") +
  # add lines to designate summer
  geom_vline(xintercept= as.numeric(as.Date('2016-5-6')),
             linetype="dotted", size=0.5, colour="dimgrey")+
  geom_vline(xintercept= as.numeric(as.Date('2016-8-22')),
             linetype="dotted", size=0.5, colour="dimgrey") +
  labs(title="Total Items Sold: State Dotted, Pullman Solid",
       y = "Total Items Sold",
       x = "Date, Summer Indicated in Bracket")


# dots for Pullman and overall state average

daily_agg_summary_vPullman <- daily_aggregate %>%
  mutate(is_Pullman = (city=="PULLMAN")) %>%
  group_by(saledate, is_Pullman) %>%
  summarise(revenue = mean(revenue, na.rm=T),
            tot_items = mean(tot_items, na.rm=T),
            avg_price_peritem = mean(avg_price_peritem, na.rm=T),
            perc.usable = mean(perc.usable, na.rm=T),
            perc.edible = mean(perc.edible, na.rm=T),
            perc.extracts = mean(perc.extracts, na.rm=T),
            city = "State_Avg")

daily_agg_summary_vPullman %>%
  filter(!is.na(is_Pullman)) %>%
  ggplot(aes(x=saledate, y=tot_items)) +
  geom_point(aes(color=is_Pullman)) +
  geom_smooth(data=subset(daily_agg_summary_vPullman, is_Pullman),
              mapping = aes(x=saledate, y=tot_items),
              method = 'loess', color =  "blue3", linetype="dashed") +
  geom_smooth(data=subset(daily_agg_summary_vPullman, !is_Pullman),
              mapping = aes(x=saledate, y=tot_items),
              method = 'loess', color =  "red", linetype="dashed") +
  # add lines to designate summer
  geom_vline(xintercept= as.numeric(as.Date('2016-05-06')),
             linetype="dotted", size=1, colour="dimgrey")+
  geom_vline(xintercept= as.numeric(as.Date('2016-08-22')),
             linetype="dotted", size=1, colour="dimgrey")

daily_agg_summary_vPullman %>%
  dplyr::filter(!is.na(is_Pullman)) %>%
  dplyr::rename(Usable = perc.usable, Edibles = perc.edible, Extracts = perc.extracts) %>%
  tidyr::gather(product_type, perc_items_sold, 6:8) %>%
  ggplot(aes(x=saledate, y=perc_items_sold)) +
  geom_point(aes(color=product_type)) +
  facet_wrap("is_Pullman") +
  # add lines to designate summer
  geom_vline(xintercept= as.numeric(as.Date('2016-05-06')),
             linetype="dotted", size=1, colour="dimgrey")+
  geom_vline(xintercept= as.numeric(as.Date('2016-08-22')),
             linetype="dotted", size=1, colour="dimgrey")


daily_agg_summary_vPullman %>%
  dplyr::filter(!is.na(is_Pullman), saledate > "2016-01-01") %>%
  dplyr::rename(Usable = perc.usable, Edibles = perc.edible, Extracts = perc.extracts) %>%
  tidyr::gather(product_type, perc_items_sold, 6:8) %>%
  dplyr::filter(product_type!="Usable") %>%
  ggplot(aes(x=saledate, y=perc_items_sold)) +
  geom_point(aes(color=product_type)) +
  facet_wrap("is_Pullman") +
  # add lines to designate summer
  geom_vline(xintercept= as.numeric(as.Date('2016-05-06')),
             linetype="dotted", size=1, colour="dimgrey")+
  geom_vline(xintercept= as.numeric(as.Date('2016-08-22')),
             linetype="dotted", size=1, colour="dimgrey")



  # State aggregate
  # geom_smooth(data=subset(daily_aggregate, saledate >= "2016-01-01" & saledate <= "2016-05-05"),
  #             mapping = aes(x=saledate,y=tot_items),
  #             method = 'lm', formula = y~ns(x, df=2), color =  "blue3", linetype="dashed") +
  # geom_smooth(data=subset(daily_aggregate, saledate >= "2016-05-05" & 
  #                           saledate <= "2016-08-22"),
  #             mapping = aes(x=saledate,y=tot_items), 
  #             method = 'lm', formula = y~ns(x, df=2), color =  "blue3", linetype="dashed") +
  # geom_smooth(data=subset(daily_aggregate, saledate >= "2016-08-22"),
  #             mapping = aes(x=saledate,y=tot_items), 
  #             method = 'lm', formula = y~ns(x, df=2), color =  "blue3", linetype="dashed") +
  # # just Pullman
  # geom_smooth(data=subset(daily_aggregate, city=="PULLMAN" & saledate >= "2016-01-01" & saledate <= "2016-05-05"),
  #             mapping = aes(x=saledate,y=tot_items),
  #             method = 'lm', formula = y~ns(x, df=2), color =  "darkgreen") +
  # geom_smooth(data=subset(daily_aggregate, city=="PULLMAN" & saledate >= "2016-05-05" & 
  #                           saledate <= "2016-08-22"),
  #             mapping = aes(x=saledate,y=tot_items), 
  #             method = 'lm', formula = y~ns(x, df=2), color =  "darkgreen") +
  # geom_smooth(data=subset(daily_aggregate, city=="PULLMAN" & saledate >= "2016-08-22"),
  #             mapping = aes(x=saledate,y=tot_items), 
  #             method = 'lm', formula = y~ns(x, df=2), color =  "darkgreen") +
  # add lines to designate summer
  geom_vline(xintercept= as.numeric(as.Date('2016-5-6')),
             linetype="dotted", size=0.5, colour="dimgrey")+
  geom_vline(xintercept= as.numeric(as.Date('2016-8-22')),
             linetype="dotted", size=0.5, colour="dimgrey") +
  labs(title="Total Items Sold: State Dotted, Pullman Solid",
       y = "Total Items Sold",
       x = "Date, Summer Indicated in Bracket")

```

## Consumer Behavior in Pullman, Washington

Start by looking at quantity and mix of products sold in Pullman, comparing the school year and summertime.

##### Overall total items sold

```{r plots_college_summer, echo=FALSE, message=FALSE, fig.width=6, fig.height=4.5}
# total items sold
daily_aggregate %>%
  #filter(collegetown==TRUE) %>%
  #filter(city=="PULLMAN", city=="WALLA WALLA", city=="ELLENSBURG") %>%
  filter(city=="PULLMAN") %>%
  ggplot(aes(x=saledate, y=tot_items)) +
  geom_point() +
  # different regression lines for spring, summer, and fall
  geom_smooth(data=subset(daily_aggregate, city=="PULLMAN" & saledate <= "2016-05-05"),
              mapping = aes(x=saledate,y=tot_items),
              method = 'lm',color =  "#CC79A7") +
  geom_smooth(data=subset(daily_aggregate, city=="PULLMAN" & saledate >= "2016-05-05" & 
                            saledate <= "2016-08-22"),
              mapping = aes(x=saledate,y=tot_items), 
              method = 'lm',color =  "#CC79A7") +
  geom_smooth(data=subset(daily_aggregate, city=="PULLMAN" & saledate >= "2016-08-22"),
              mapping = aes(x=saledate,y=tot_items), 
              method = 'lm',color =  "#CC79A7") +
  # add lines to designate summer
  geom_vline(xintercept= as.numeric(as.Date('2016-5-6')),
             linetype="dashed", size=1, colour="darkgreen")+
  geom_vline(xintercept= as.numeric(as.Date('2016-8-22')),
             linetype="dashed", size=1, colour="darkgreen") +
  labs(title="Total Items Sold",
       y = "Total Items Sold",
       x = "Date, Summer Indicated in Green Bracket")
```

##### Percent of sales that are extracts for inhalation

##### Statewide and Other City Trends

##### Percent of products sold that are edibles

```{r pullman_edibles, fig.width=6, fig.height=4.5}
  
# extracts proportion
daily_aggregate %>%
  #filter(collegetown==TRUE) %>%
  #filter(city=="PULLMAN", city=="WALLA WALLA", city=="ELLENSBURG") %>%
  filter(city=="PULLMAN") %>%
  ggplot(aes(x=saledate, y=perc.edible)) +
  geom_point() +
  # different regression lines for spring, summer, and fall
  geom_smooth(data=subset(daily_aggregate, city=="PULLMAN" & saledate <= "2016-05-05"),
              mapping = aes(x=saledate,y=perc.edible),
              method = 'lm',color =  "#CC79A7") +
  geom_smooth(data=subset(daily_aggregate, city=="PULLMAN" & saledate >= "2016-05-05" & 
                            saledate <= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.edible), 
              method = 'lm',color =  "#CC79A7") +
  geom_smooth(data=subset(daily_aggregate, city=="PULLMAN" & saledate >= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.edible), 
              method = 'lm',color =  "#CC79A7") +
  # add lines to designate summer
  geom_vline(xintercept= as.numeric(as.Date('2016-5-6')),
             linetype="dashed", size=1, colour="darkgreen")+
  geom_vline(xintercept= as.numeric(as.Date('2016-8-22')),
             linetype="dashed", size=1, colour="darkgreen") +
  labs(title="Percent of Sales that are Edibles",
       y = "Percent Edibles",
       x = "Date, Summer Indicated in Green Bracket")


# extracts proportion
daily_aggregate %>%
  #filter(collegetown==TRUE) %>%
  #filter(city=="PULLMAN", city=="WALLA WALLA", city=="ELLENSBURG") %>%
  filter(city=="PULLMAN") %>%
  ggplot(aes(x=saledate, y=avg_price_peritem)) +
  geom_point() +
  # different regression lines for spring, summer, and fall
  geom_smooth(data=subset(daily_aggregate, city=="PULLMAN" & saledate <= "2016-05-05"),
              mapping = aes(x=saledate,y=avg_price_peritem),
              method = 'lm',color =  "#CC79A7") +
  geom_smooth(data=subset(daily_aggregate, city=="PULLMAN" & saledate >= "2016-05-05" & 
                            saledate <= "2016-08-22"),
              mapping = aes(x=saledate,y=avg_price_peritem), 
              method = 'lm',color =  "#CC79A7") +
  geom_smooth(data=subset(daily_aggregate, city=="PULLMAN" & saledate >= "2016-08-22"),
              mapping = aes(x=saledate,y=avg_price_peritem), 
              method = 'lm',color =  "#CC79A7") +
  # add lines to designate summer
  geom_vline(xintercept= as.numeric(as.Date('2016-5-6')),
             linetype="dashed", size=1, colour="darkgreen")+
  geom_vline(xintercept= as.numeric(as.Date('2016-8-22')),
             linetype="dashed", size=1, colour="darkgreen") +
  labs(title="Average Price per Item Sold",
       y = "Average Price",
       x = "Date, Summer Indicated in Green Bracket")

# Ellensburg ------------

# extracts proportion
daily_aggregate %>%
  #filter(collegetown==TRUE) %>%
  #filter(city=="PULLMAN", city=="WALLA WALLA", city=="ELLENSBURG") %>%
  filter(city=="ELLENSBURG", perc.usable > 0.5) %>%
  ### we could add winter break
  ggplot(aes(x=saledate, y=perc.usable)) +
  geom_point() +
  # different regression lines for spring, summer, and fall
  geom_smooth(data=subset(daily_aggregate, city=="ELLENSBURG" & saledate <= "2016-06-09"),
              mapping = aes(x=saledate,y=perc.usable),
              method = 'lm',color =  "#CC79A7") +
  geom_smooth(data=subset(daily_aggregate, city=="ELLENSBURG" & saledate >= "2016-06-09" & 
                            saledate <= "2016-09-21"),
              mapping = aes(x=saledate,y=perc.usable), 
              method = 'lm',color =  "#CC79A7") +
  geom_smooth(data=subset(daily_aggregate, city=="ELLENSBURG" & saledate >= "2016-09-21"),
              mapping = aes(x=saledate,y=perc.usable), 
              method = 'lm',color =  "#CC79A7") +
  # add lines to designate summer
  geom_vline(xintercept= as.numeric(as.Date("2016-06-09")),
             linetype="dashed", size=1, colour="darkgreen")+
  geom_vline(xintercept= as.numeric(as.Date("2016-09-21")),
             linetype="dashed", size=1, colour="darkgreen") +
  labs(title="Percent of Sales that are Usable",
       y = "Percent Edibles",
       x = "Date, Summer Indicated in Green Bracket")

# extracts proportion
daily_aggregate %>%
  #filter(collegetown==TRUE) %>%
  #filter(city=="PULLMAN", city=="WALLA WALLA", city=="ELLENSBURG") %>%
  filter(city=="ELLENSBURG") %>%
  ggplot(aes(x=saledate, y=perc.extracts)) +
  geom_point() +
  # different regression lines for spring, summer, and fall
  geom_smooth(data=subset(daily_aggregate, city=="ELLENSBURG" & saledate <= "2016-06-09"),
              mapping = aes(x=saledate,y=perc.extracts),
              method = 'lm',color =  "#CC79A7") +
  geom_smooth(data=subset(daily_aggregate, city=="ELLENSBURG" & saledate >= "2016-06-09" & 
                            saledate <= "2016-09-21"),
              mapping = aes(x=saledate,y=perc.extracts), 
              method = 'lm',color =  "#CC79A7") +
  geom_smooth(data=subset(daily_aggregate, city=="ELLENSBURG" & saledate >= "2016-09-21"),
              mapping = aes(x=saledate,y=perc.extracts), 
              method = 'lm',color =  "#CC79A7") +
  # add lines to designate summer
  geom_vline(xintercept= as.numeric(as.Date("2016-06-09")),
             linetype="dashed", size=1, colour="darkgreen")+
  geom_vline(xintercept= as.numeric(as.Date("2016-09-21")),
             linetype="dashed", size=1, colour="darkgreen") +
  labs(title="Percent of Sales that are Usable, Ellensburg")
  
# Bellingham -----

# extracts proportion
daily_aggregate %>%
  #filter(collegetown==TRUE) %>%
  #filter(city=="PULLMAN", city=="WALLA WALLA", city=="ELLENSBURG") %>%
  filter(city=="BELLINGHAM") %>%
  ggplot(aes(x=saledate, y=perc.usable)) +
  geom_point() +
  # different regression lines for spring, summer, and fall
  geom_smooth(data=subset(daily_aggregate, city=="BELLINGHAM" & saledate <= "2016-06-09"),
              mapping = aes(x=saledate,y=perc.usable),
              method = 'lm',color =  "#CC79A7") +
  geom_smooth(data=subset(daily_aggregate, city=="BELLINGHAM" & saledate >= "2016-06-09" & 
                            saledate <= "2016-09-21"),
              mapping = aes(x=saledate,y=perc.usable), 
              method = 'lm',color =  "#CC79A7") +
  geom_smooth(data=subset(daily_aggregate, city=="BELLINGHAM" & saledate >= "2016-09-21"),
              mapping = aes(x=saledate,y=perc.usable), 
              method = 'lm',color =  "#CC79A7") +
  # add lines to designate summer
  geom_vline(xintercept= as.numeric(as.Date("2016-06-09")),
             linetype="dashed", size=1, colour="darkgreen")+
  geom_vline(xintercept= as.numeric(as.Date("2016-09-21")),
             linetype="dashed", size=1, colour="darkgreen") +
  labs(title="Percent of Sales that are Usable, BELLINGHAM")
  

# extracts proportion
daily_aggregate %>%
  #filter(collegetown==TRUE) %>%
  #filter(city=="PULLMAN", city=="WALLA WALLA", city=="ELLENSBURG") %>%
  filter(city=="BELLINGHAM") %>%
  ggplot(aes(x=saledate, y=perc.edible)) +
  geom_point() +
  # different regression lines for spring, summer, and fall
  geom_smooth(data=subset(daily_aggregate, city=="BELLINGHAM" & saledate <= "2016-06-09"),
              mapping = aes(x=saledate,y=perc.edible),
              method = 'lm',color =  "#CC79A7") +
  geom_smooth(data=subset(daily_aggregate, city=="BELLINGHAM" & saledate >= "2016-06-09" & 
                            saledate <= "2016-09-21"),
              mapping = aes(x=saledate,y=perc.edible), 
              method = 'lm',color =  "#CC79A7") +
  geom_smooth(data=subset(daily_aggregate, city=="BELLINGHAM" & saledate >= "2016-09-21"),
              mapping = aes(x=saledate,y=perc.edible), 
              method = 'lm',color =  "#CC79A7") +
  # add lines to designate summer
  geom_vline(xintercept= as.numeric(as.Date("2016-06-09")),
             linetype="dashed", size=1, colour="darkgreen")+
  geom_vline(xintercept= as.numeric(as.Date("2016-09-21")),
             linetype="dashed", size=1, colour="darkgreen") +
  labs(title="Percent of Sales that are Edible, BELLINGHAM")


# extracts proportion
daily_aggregate %>%
  #filter(collegetown==TRUE) %>%
  #filter(city=="PULLMAN", city=="WALLA WALLA", city=="ELLENSBURG") %>%
  filter(city=="BREMERTON") %>%
  ggplot(aes(x=saledate, y=perc.usable)) +
  geom_point() +
  # different regression lines for spring, summer, and fall
  geom_smooth(data=subset(daily_aggregate, city=="BREMERTON" & saledate <= "2016-06-09"),
              mapping = aes(x=saledate,y=perc.usable),
              method = 'lm',color =  "#CC79A7") +
  geom_smooth(data=subset(daily_aggregate, city=="BREMERTON" & saledate >= "2016-06-09" & 
                            saledate <= "2016-09-21"),
              mapping = aes(x=saledate,y=perc.usable), 
              method = 'lm',color =  "#CC79A7") +
  geom_smooth(data=subset(daily_aggregate, city=="BREMERTON" & saledate >= "2016-09-21"),
              mapping = aes(x=saledate,y=perc.usable), 
              method = 'lm',color =  "#CC79A7") +
  # add lines to designate summer
  geom_vline(xintercept= as.numeric(as.Date("2016-06-09")),
             linetype="dashed", size=1, colour="darkgreen")+
  geom_vline(xintercept= as.numeric(as.Date("2016-09-21")),
             linetype="dashed", size=1, colour="darkgreen") +
  labs(title="Percent of Sales that are Usable, BREMERTON")

# Des Moines

# extracts proportion
daily_aggregate %>%
  #filter(collegetown==TRUE) %>%
  #filter(city=="PULLMAN", city=="WALLA WALLA", city=="ELLENSBURG") %>%
  filter(city=="DES MOINES") %>%
  ggplot(aes(x=saledate, y=perc.usable)) +
  geom_point() +
  # different regression lines for spring, summer, and fall
  geom_smooth(data=subset(daily_aggregate, city=="DES MOINES" & saledate <= "2016-06-09"),
              mapping = aes(x=saledate,y=perc.usable),
              method = 'lm',color =  "#CC79A7") +
  geom_smooth(data=subset(daily_aggregate, city=="DES MOINES" & saledate >= "2016-06-09" & 
                            saledate <= "2016-09-21"),
              mapping = aes(x=saledate,y=perc.usable), 
              method = 'lm',color =  "#CC79A7") +
  geom_smooth(data=subset(daily_aggregate, city=="DES MOINES" & saledate >= "2016-09-21"),
              mapping = aes(x=saledate,y=perc.usable), 
              method = 'lm',color =  "#CC79A7") +
  # add lines to designate summer
  geom_vline(xintercept= as.numeric(as.Date("2016-06-09")),
             linetype="dashed", size=1, colour="darkgreen")+
  geom_vline(xintercept= as.numeric(as.Date("2016-09-21")),
             linetype="dashed", size=1, colour="darkgreen") +
  labs(title="Percent of Sales that are Usable, DES MOINES")

```

#### Perc Product by Big City, Noncollege-Nonurban, and Pullman

```{r perc_city_noncollege_Pullman}

# Perc Extracts, by Pullman, Urban, Noncollege-Nonurban --------
daily_aggregate_byTownType %>%
  ggplot(aes(x=saledate, y=perc.extracts)) +
  # different regression lines for spring, summer, and fall
  geom_smooth(data=subset(daily_aggregate_byTownType, towntype_Pullman=="Pullman" & saledate >= "2015-08-01" &
                            saledate <="2016-05-05"),
              mapping = aes(x=saledate,y=perc.extracts),
              method = 'lm',color =  "#d95f02") +
  geom_smooth(data=subset(daily_aggregate_byTownType, towntype_Pullman=="Pullman" & saledate >= "2016-05-05" & 
                            saledate <= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.extracts), 
              method = 'lm',color =  "#d95f02") +
  geom_smooth(data=subset(daily_aggregate_byTownType, towntype_Pullman=="Pullman" & saledate >= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.extracts), 
              method = 'lm',color =  "#d95f02") +
  # different regression lines for spring, summer, and fall
  geom_smooth(data=subset(daily_aggregate_byTownType, towntype_Pullman=="bigcity" & saledate >= "2015-08-01" &
                            saledate <="2016-05-05"),
              mapping = aes(x=saledate,y=perc.extracts),
              method = 'lm',color =  "#1b9e77") +
  geom_smooth(data=subset(daily_aggregate_byTownType, towntype_Pullman=="bigcity" & saledate >= "2016-05-05" & 
                            saledate <= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.extracts), 
              method = 'lm',color =  "#1b9e77") +
  geom_smooth(data=subset(daily_aggregate_byTownType, towntype_Pullman=="bigcity" & saledate >= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.extracts), 
              method = 'lm',color =  "#1b9e77") +
   # different regression lines for spring, summer, and fall
  geom_smooth(data=subset(daily_aggregate_byTownType, towntype_Pullman=="noncollege-nonurban" & saledate >= "2015-08-01" &
                            saledate <="2016-05-05"),
              mapping = aes(x=saledate,y=perc.extracts),
              method = 'lm',color =  "#7570b3") +
  geom_smooth(data=subset(daily_aggregate_byTownType, towntype_Pullman=="noncollege-nonurban" & saledate >= "2016-05-05" & 
                            saledate <= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.extracts), 
              method = 'lm',color =  "#7570b3") +
  geom_smooth(data=subset(daily_aggregate_byTownType, towntype_Pullman=="noncollege-nonurban" & saledate >= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.extracts), 
              method = 'lm',color =  "#7570b3") +
  # add lines to designate summer
  geom_vline(xintercept= as.numeric(as.Date('2016-5-6')),
             linetype="dashed", size=1, colour="darkgreen")+
  geom_vline(xintercept= as.numeric(as.Date('2016-8-22')),
             linetype="dashed", size=1, colour="darkgreen") +
  labs(title="Percent of Sales that are Extracts, Pullman Orange, Big Cities Green, NonCollege-NonUrban Purple")


# Perc Edibles, by Pullman, Urban, Noncollege-Nonurban --------
daily_aggregate_byTownType %>%
  ggplot(aes(x=saledate, y=perc.edible)) +
  # different regression lines for spring, summer, and fall
  geom_smooth(data=subset(daily_aggregate_byTownType, towntype_Pullman=="Pullman" & saledate >= "2015-08-01" &
                            saledate <="2016-05-05"),
              mapping = aes(x=saledate,y=perc.edible),
              method = 'lm',color =  "#d95f02") +
  geom_smooth(data=subset(daily_aggregate_byTownType, towntype_Pullman=="Pullman" & saledate >= "2016-05-05" & 
                            saledate <= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.edible), 
              method = 'lm',color =  "#d95f02") +
  geom_smooth(data=subset(daily_aggregate_byTownType, towntype_Pullman=="Pullman" & saledate >= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.edible), 
              method = 'lm',color =  "#d95f02") +
  # different regression lines for spring, summer, and fall
  geom_smooth(data=subset(daily_aggregate_byTownType, towntype_Pullman=="bigcity" & saledate >= "2015-08-01" &
                            saledate <="2016-05-05"),
              mapping = aes(x=saledate,y=perc.edible),
              method = 'lm',color =  "#1b9e77") +
  geom_smooth(data=subset(daily_aggregate_byTownType, towntype_Pullman=="bigcity" & saledate >= "2016-05-05" & 
                            saledate <= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.edible), 
              method = 'lm',color =  "#1b9e77") +
  geom_smooth(data=subset(daily_aggregate_byTownType, towntype_Pullman=="bigcity" & saledate >= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.edible), 
              method = 'lm',color =  "#1b9e77") +
   # different regression lines for spring, summer, and fall
  geom_smooth(data=subset(daily_aggregate_byTownType, towntype_Pullman=="noncollege-nonurban" & saledate >= "2015-08-01" &
                            saledate <="2016-05-05"),
              mapping = aes(x=saledate,y=perc.edible),
              method = 'lm',color =  "#7570b3") +
  geom_smooth(data=subset(daily_aggregate_byTownType, towntype_Pullman=="noncollege-nonurban" & saledate >= "2016-05-05" & 
                            saledate <= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.edible), 
              method = 'lm',color =  "#7570b3") +
  geom_smooth(data=subset(daily_aggregate_byTownType, towntype_Pullman=="noncollege-nonurban" & saledate >= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.edible), 
              method = 'lm',color =  "#7570b3") +
  # add lines to designate summer
  geom_vline(xintercept= as.numeric(as.Date('2016-5-6')),
             linetype="dashed", size=1, colour="darkgreen")+
  geom_vline(xintercept= as.numeric(as.Date('2016-8-22')),
             linetype="dashed", size=1, colour="darkgreen") +
  labs(title="Percent of Sales that are Edibles, Pullman Orange, Big Cities Green, NonCollege-NonUrban Purple")




# Perc Usable, by Pullman, Urban, Noncollege-Nonurban --------
daily_aggregate_byTownType %>%
  ggplot(aes(x=saledate, y=perc.usable)) +
  # different regression lines for spring, summer, and fall
  geom_smooth(data=subset(daily_aggregate_byTownType, towntype_Pullman=="Pullman" & saledate >= "2015-08-01" &
                            saledate <="2016-05-05"),
              mapping = aes(x=saledate,y=perc.usable),
              method = 'lm',color =  "#d95f02") +
  geom_smooth(data=subset(daily_aggregate_byTownType, towntype_Pullman=="Pullman" & saledate >= "2016-05-05" & 
                            saledate <= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.usable), 
              method = 'lm',color =  "#d95f02") +
  geom_smooth(data=subset(daily_aggregate_byTownType, towntype_Pullman=="Pullman" & saledate >= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.usable), 
              method = 'lm',color =  "#d95f02") +
  # different regression lines for spring, summer, and fall
  geom_smooth(data=subset(daily_aggregate_byTownType, towntype_Pullman=="bigcity" & saledate >= "2015-08-01" &
                            saledate <="2016-05-05"),
              mapping = aes(x=saledate,y=perc.usable),
              method = 'lm',color =  "#1b9e77") +
  geom_smooth(data=subset(daily_aggregate_byTownType, towntype_Pullman=="bigcity" & saledate >= "2016-05-05" & 
                            saledate <= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.usable), 
              method = 'lm',color =  "#1b9e77") +
  geom_smooth(data=subset(daily_aggregate_byTownType, towntype_Pullman=="bigcity" & saledate >= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.usable), 
              method = 'lm',color =  "#1b9e77") +
   # different regression lines for spring, summer, and fall
  geom_smooth(data=subset(daily_aggregate_byTownType, towntype_Pullman=="noncollege-nonurban" & saledate >= "2015-08-01" &
                            saledate <="2016-05-05"),
              mapping = aes(x=saledate,y=perc.usable),
              method = 'lm',color =  "#7570b3") +
  geom_smooth(data=subset(daily_aggregate_byTownType, towntype_Pullman=="noncollege-nonurban" & saledate >= "2016-05-05" & 
                            saledate <= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.usable), 
              method = 'lm',color =  "#7570b3") +
  geom_smooth(data=subset(daily_aggregate_byTownType, towntype_Pullman=="noncollege-nonurban" & saledate >= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.usable), 
              method = 'lm',color =  "#7570b3") +
  # add lines to designate summer
  geom_vline(xintercept= as.numeric(as.Date('2016-5-6')),
             linetype="dashed", size=1, colour="darkgreen")+
  geom_vline(xintercept= as.numeric(as.Date('2016-8-22')),
             linetype="dashed", size=1, colour="darkgreen") +
  labs(title="Percent of Sales that are Usable, Pullman Orange, Big Cities Green, NonCollege-NonUrban Purple")




# Volume Edible, by Pullman, Urban, Noncollege-Nonurban --------
daily_aggregate_byTownType %>%
  ggplot(aes(x=saledate, y=(tot_items*perc.edible))) +
  # different regression lines for spring, summer, and fall
  geom_smooth(data=subset(daily_aggregate_byTownType, towntype_Pullman=="Pullman" & saledate >= "2015-08-01" &
                            saledate <="2016-05-05"),
              mapping = aes(x=saledate,y=(tot_items*perc.edible)),
              method = 'lm',color =  "#d95f02") +
  geom_smooth(data=subset(daily_aggregate_byTownType, towntype_Pullman=="Pullman" & saledate >= "2016-05-05" & 
                            saledate <= "2016-08-22"),
              mapping = aes(x=saledate,y=(tot_items*perc.edible)), 
              method = 'lm',color =  "#d95f02") +
  geom_smooth(data=subset(daily_aggregate_byTownType, towntype_Pullman=="Pullman" & saledate >= "2016-08-22"),
              mapping = aes(x=saledate,y=(tot_items*perc.edible)), 
              method = 'lm',color =  "#d95f02") +
  # different regression lines for spring, summer, and fall
  geom_smooth(data=subset(daily_aggregate_byTownType, towntype_Pullman=="bigcity" & saledate >= "2015-08-01" &
                            saledate <="2016-05-05"),
              mapping = aes(x=saledate,y=(tot_items*perc.edible)),
              method = 'lm',color =  "#1b9e77") +
  geom_smooth(data=subset(daily_aggregate_byTownType, towntype_Pullman=="bigcity" & saledate >= "2016-05-05" & 
                            saledate <= "2016-08-22"),
              mapping = aes(x=saledate,y=(tot_items*perc.edible)), 
              method = 'lm',color =  "#1b9e77") +
  geom_smooth(data=subset(daily_aggregate_byTownType, towntype_Pullman=="bigcity" & saledate >= "2016-08-22"),
              mapping = aes(x=saledate,y=(tot_items*perc.edible)), 
              method = 'lm',color =  "#1b9e77") +
   # different regression lines for spring, summer, and fall
  geom_smooth(data=subset(daily_aggregate_byTownType, towntype_Pullman=="noncollege-nonurban" & saledate >= "2015-08-01" &
                            saledate <="2016-05-05"),
              mapping = aes(x=saledate,y=(tot_items*perc.edible)),
              method = 'lm',color =  "#7570b3") +
  geom_smooth(data=subset(daily_aggregate_byTownType, towntype_Pullman=="noncollege-nonurban" & saledate >= "2016-05-05" & 
                            saledate <= "2016-08-22"),
              mapping = aes(x=saledate,y=(tot_items*perc.edible)), 
              method = 'lm',color =  "#7570b3") +
  geom_smooth(data=subset(daily_aggregate_byTownType, towntype_Pullman=="noncollege-nonurban" & saledate >= "2016-08-22"),
              mapping = aes(x=saledate,y=(tot_items*perc.edible)), 
              method = 'lm',color =  "#7570b3") +
  # add lines to designate summer
  geom_vline(xintercept= as.numeric(as.Date('2016-5-6')),
             linetype="dashed", size=1, colour="darkgreen")+
  geom_vline(xintercept= as.numeric(as.Date('2016-8-22')),
             linetype="dashed", size=1, colour="darkgreen") +
  labs(title="Percent of Sales that are Usable, Pullman Orange, Big Cities Green, NonCollege-NonUrban Purple")


```


#### Perc Product by Noncollege-Nonurban, and Pullman

```{r perc_noncollege_Pullman}

# Perc Extracts, by Pullman, Urban, Noncollege-Nonurban --------
daily_aggregate_byTownType %>%
  ggplot(aes(x=saledate, y=perc.extracts)) +
  # different regression lines for spring, summer, and fall
  geom_smooth(data=subset(daily_aggregate_byTownType, towntype_Pullman=="Pullman" & saledate >= "2015-08-01" &
                            saledate <="2016-05-05"),
              mapping = aes(x=saledate,y=perc.extracts),
              method = 'lm', formula = y~ns(x, df=1),color =  "#d95f02") +
  geom_smooth(data=subset(daily_aggregate_byTownType, towntype_Pullman=="Pullman" & saledate >= "2016-05-05" & 
                            saledate <= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.extracts), 
              method = 'lm', formula = y~ns(x, df=1),color =  "#d95f02") +
  geom_smooth(data=subset(daily_aggregate_byTownType, towntype_Pullman=="Pullman" & saledate >= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.extracts), 
              method = 'lm', formula = y~ns(x, df=1),color =  "#d95f02") +
   # different regression lines for spring, summer, and fall
  geom_smooth(data=subset(daily_aggregate_byTownType, towntype_Pullman=="noncollege-nonurban" & saledate >= "2015-08-01" &
                            saledate <="2016-05-05"),
              mapping = aes(x=saledate,y=perc.extracts),
              method = 'lm', formula = y~ns(x, df=1),color =  "#7570b3", linetype="twodash") +
  geom_smooth(data=subset(daily_aggregate_byTownType, towntype_Pullman=="noncollege-nonurban" & saledate >= "2016-05-05" & 
                            saledate <= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.extracts), 
              method = 'lm', formula = y~ns(x, df=1),color =  "#7570b3", linetype="twodash") +
  geom_smooth(data=subset(daily_aggregate_byTownType, towntype_Pullman=="noncollege-nonurban" & saledate >= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.extracts), 
              method = 'lm', formula = y~ns(x, df=1),color =  "#7570b3", linetype="twodash") +
  # add lines to designate summer
  geom_vline(xintercept= as.numeric(as.Date('2016-5-6')),
             linetype="dashed", size=0.5, colour="dimgrey")+
  geom_vline(xintercept= as.numeric(as.Date('2016-8-22')),
             linetype="dashed", size=0.5, colour="dimgrey") +
  labs(title="% Sale Extracts, \nPullman Orange, NonCollege-NonUrban Purple",
       x="Sale Date",
       y="% Extracts")


# Perc Edibles, by Pullman, Urban, Noncollege-Nonurban --------
daily_aggregate_byTownType %>%
  ggplot(aes(x=saledate, y=perc.edible)) +
  # different regression lines for spring, summer, and fall
  geom_smooth(data=subset(daily_aggregate_byTownType, towntype_Pullman=="Pullman" & saledate >= "2016-01-01" &
                            saledate <="2016-05-05"),
              mapping = aes(x=saledate,y=perc.edible),
              method = 'lm', formula = y~ns(x, df=2),color =  "#d95f02") +
  geom_smooth(data=subset(daily_aggregate_byTownType, towntype_Pullman=="Pullman" & saledate >= "2016-05-05" & 
                            saledate <= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.edible), 
              method = 'lm', formula = y~ns(x, df=2),color =  "#d95f02") +
  geom_smooth(data=subset(daily_aggregate_byTownType, towntype_Pullman=="Pullman" & saledate >= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.edible), 
              method = 'lm', formula = y~ns(x, df=2),color =  "#d95f02") +
   # different regression lines for spring, summer, and fall
  geom_smooth(data=subset(daily_aggregate_byTownType, towntype_Pullman=="noncollege-nonurban" & saledate >= "2016-01-01" &
                            saledate <="2016-05-05"),
              mapping = aes(x=saledate,y=perc.edible),
              method = 'lm', formula = y~ns(x, df=2),color =  "#7570b3", linetype="twodash") +
  geom_smooth(data=subset(daily_aggregate_byTownType, towntype_Pullman=="noncollege-nonurban" & saledate >= "2016-05-05" & 
                            saledate <= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.edible), 
              method = 'lm', formula = y~ns(x, df=2),color =  "#7570b3", linetype="twodash") +
  geom_smooth(data=subset(daily_aggregate_byTownType, towntype_Pullman=="noncollege-nonurban" & saledate >= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.edible), 
              method = 'lm', formula = y~ns(x, df=2),color =  "#7570b3", linetype="twodash") +
  # add lines to designate summer
  geom_vline(xintercept= as.numeric(as.Date('2016-5-6')),
             linetype="dashed", size=1, colour="darkgreen")+
  geom_vline(xintercept= as.numeric(as.Date('2016-8-22')),
             linetype="dashed", size=1, colour="darkgreen") +
  labs(title="% Sales Edibles, \nPullman Orange, NonCollege-NonUrban Purple",
       x="Sale Date",
       y="% Edibles")


# Perc Usable, by Pullman, Urban, Noncollege-Nonurban --------
daily_aggregate_byTownType %>%
  ggplot(aes(x=saledate, y=perc.usable)) +
  # different regression lines for spring, summer, and fall
  geom_smooth(data=subset(daily_aggregate_byTownType, towntype_Pullman=="Pullman" & saledate >= "2016-01-01" &
                            saledate <="2016-05-05"),
              mapping = aes(x=saledate,y=perc.usable),
              method = 'lm', formula = y~ns(x, df=2),color =  "#d95f02") +
  geom_smooth(data=subset(daily_aggregate_byTownType, towntype_Pullman=="Pullman" & saledate >= "2016-05-05" & 
                            saledate <= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.usable), 
              method = 'lm', formula = y~ns(x, df=2),color =  "#d95f02") +
  geom_smooth(data=subset(daily_aggregate_byTownType, towntype_Pullman=="Pullman" & saledate >= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.usable), 
              method = 'lm', formula = y~ns(x, df=2),color =  "#d95f02") +
   # different regression lines for spring, summer, and fall
  geom_smooth(data=subset(daily_aggregate_byTownType, towntype_Pullman=="noncollege-nonurban" & saledate >= "2016-01-01" &
                            saledate <="2016-05-05"),
              mapping = aes(x=saledate,y=perc.usable),
              method = 'lm', formula = y~ns(x, df=2),color =  "#7570b3", linetype="twodash") +
  geom_smooth(data=subset(daily_aggregate_byTownType, towntype_Pullman=="noncollege-nonurban" & saledate >= "2016-05-05" & 
                            saledate <= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.usable), 
              method = 'lm', formula = y~ns(x, df=2),color =  "#7570b3", linetype="twodash") +
  geom_smooth(data=subset(daily_aggregate_byTownType, towntype_Pullman=="noncollege-nonurban" & saledate >= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.usable), 
              method = 'lm', formula = y~ns(x, df=2),color =  "#7570b3", linetype="twodash") +
  # add lines to designate summer
  geom_vline(xintercept= as.numeric(as.Date('2016-5-6')),
             linetype="dashed", size=0.5, colour="dimgrey")+
  geom_vline(xintercept= as.numeric(as.Date('2016-8-22')),
             linetype="dashed", size=0.5, colour="dimgrey") +
  labs(title="% of Sales Usable, \nPullman Orange, NonCollege-NonUrban Purple",
       x="Sale Date",
       y="% Usable")


####### amounts not pecentse

# Perc Extracts, by Pullman, Urban, Noncollege-Nonurban --------
daily_aggregate_byTownType %>%
  ggplot(aes(x=saledate, y=perc.extracts)) +
  # different regression lines for spring, summer, and fall
  geom_smooth(data=subset(daily_aggregate_byTownType, towntype_Pullman=="Pullman" & saledate >= "2015-08-01" &
                            saledate <="2016-05-05"),
              mapping = aes(x=saledate,y=perc.extracts),
              method = 'lm', formula = y~ns(x, df=1),color =  "#d95f02") +
  geom_smooth(data=subset(daily_aggregate_byTownType, towntype_Pullman=="Pullman" & saledate >= "2016-05-05" & 
                            saledate <= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.extracts), 
              method = 'lm', formula = y~ns(x, df=1),color =  "#d95f02") +
  geom_smooth(data=subset(daily_aggregate_byTownType, towntype_Pullman=="Pullman" & saledate >= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.extracts), 
              method = 'lm', formula = y~ns(x, df=1),color =  "#d95f02") +
   # different regression lines for spring, summer, and fall
  geom_smooth(data=subset(daily_aggregate_byTownType, towntype_Pullman=="noncollege-nonurban" & saledate >= "2015-08-01" &
                            saledate <="2016-05-05"),
              mapping = aes(x=saledate,y=perc.extracts),
              method = 'lm', formula = y~ns(x, df=1),color =  "#7570b3", linetype="twodash") +
  geom_smooth(data=subset(daily_aggregate_byTownType, towntype_Pullman=="noncollege-nonurban" & saledate >= "2016-05-05" & 
                            saledate <= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.extracts), 
              method = 'lm', formula = y~ns(x, df=1),color =  "#7570b3", linetype="twodash") +
  geom_smooth(data=subset(daily_aggregate_byTownType, towntype_Pullman=="noncollege-nonurban" & saledate >= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.extracts), 
              method = 'lm', formula = y~ns(x, df=1),color =  "#7570b3", linetype="twodash") +
  # add lines to designate summer
  geom_vline(xintercept= as.numeric(as.Date('2016-5-6')),
             linetype="dashed", size=0.5, colour="dimgrey")+
  geom_vline(xintercept= as.numeric(as.Date('2016-8-22')),
             linetype="dashed", size=0.5, colour="dimgrey") +
  labs(title="% Sale Extracts, \nPullman Orange, NonCollege-NonUrban Purple",
       x="Sale Date",
       y="% Extracts")


# Perc Edibles, by Pullman, Urban, Noncollege-Nonurban --------
daily_aggregate_byTownType %>%
  ggplot(aes(x=saledate, y=perc.edible)) +
  # different regression lines for spring, summer, and fall
  geom_smooth(data=subset(daily_aggregate_byTownType, towntype_Pullman=="Pullman" & saledate >= "2016-01-01" &
                            saledate <="2016-05-05"),
              mapping = aes(x=saledate,y=perc.edible),
              method = 'lm', formula = y~ns(x, df=2),color =  "#d95f02") +
  geom_smooth(data=subset(daily_aggregate_byTownType, towntype_Pullman=="Pullman" & saledate >= "2016-05-05" & 
                            saledate <= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.edible), 
              method = 'lm', formula = y~ns(x, df=2),color =  "#d95f02") +
  geom_smooth(data=subset(daily_aggregate_byTownType, towntype_Pullman=="Pullman" & saledate >= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.edible), 
              method = 'lm', formula = y~ns(x, df=2),color =  "#d95f02") +
   # different regression lines for spring, summer, and fall
  geom_smooth(data=subset(daily_aggregate_byTownType, towntype_Pullman=="noncollege-nonurban" & saledate >= "2016-01-01" &
                            saledate <="2016-05-05"),
              mapping = aes(x=saledate,y=perc.edible),
              method = 'lm', formula = y~ns(x, df=2),color =  "#7570b3", linetype="twodash") +
  geom_smooth(data=subset(daily_aggregate_byTownType, towntype_Pullman=="noncollege-nonurban" & saledate >= "2016-05-05" & 
                            saledate <= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.edible), 
              method = 'lm', formula = y~ns(x, df=2),color =  "#7570b3", linetype="twodash") +
  geom_smooth(data=subset(daily_aggregate_byTownType, towntype_Pullman=="noncollege-nonurban" & saledate >= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.edible), 
              method = 'lm', formula = y~ns(x, df=2),color =  "#7570b3", linetype="twodash") +
  # add lines to designate summer
  geom_vline(xintercept= as.numeric(as.Date('2016-5-6')),
             linetype="dashed", size=1, colour="darkgreen")+
  geom_vline(xintercept= as.numeric(as.Date('2016-8-22')),
             linetype="dashed", size=1, colour="darkgreen") +
  labs(title="% Sales Edibles, \nPullman Orange, NonCollege-NonUrban Purple",
       x="Sale Date",
       y="% Edibles")



##### percent, grid arrange

pullmanNCNU_compare <- daily_aggregate_byTownType %>%
  dplyr::filter(towntype_Pullman=="Pullman" | towntype_Pullman=="noncollege-nonurban") %>%
  dplyr::rename(Usable = perc.usable, Edibles = perc.edible, Extracts = perc.extracts) %>%
  tidyr::gather(product_type, perc_items_sold, 6:8)

# items sold, facet for each town + type, not usable
pullNCNU_edible_perc <- ggplot() +
  geom_smooth(data=subset(pullmanNCNU_compare, saledate >= "2016-01-01" & saledate <= "2016-05-06" &
                            product_type=="Edibles"),
              mapping = aes(x=saledate, y=perc_items_sold),
              method = 'lm', formula = y~ns(x, df=2), color="#d95f02") +
  geom_smooth(data=subset(pullmanNCNU_compare, saledate >= "2016-05-06" & saledate <= "2016-09-21" &
                            product_type=="Edibles"),
              mapping = aes(x=saledate, y=perc_items_sold), 
              method = 'lm', formula = y~ns(x, df=2), color="#d95f02") +
  geom_smooth(data=subset(pullmanNCNU_compare, saledate >= "2016-09-21" & saledate < "2017-01-01" &
                            product_type=="Edibles"),
              mapping = aes(x=saledate, y=perc_items_sold), 
              method = 'lm', formula = y~ns(x, df=2), color="#d95f02") +
  facet_grid(towntype_Pullman~product_type, scales = "free") +
  scale_x_date(date_breaks = "3 month", date_labels = "%b") +
  # add lines to designate summer
  geom_vline(xintercept= as.numeric(as.Date('2016-05-06')),
             linetype="dashed", size=0.5, colour="dimgrey")+
  geom_vline(xintercept= as.numeric(as.Date('2016-09-21')),
             linetype="dashed", size=0.5, colour="dimgrey") +
  labs(title=" ", x= 'Sale Date', y = "% of Products Sold")

pullNCNU_extract_perc <- ggplot() +
  geom_smooth(data=subset(pullmanNCNU_compare, saledate >= "2016-01-01" & saledate <= "2016-05-06" &
                            product_type=="Extracts"),
              mapping = aes(x=saledate, y=perc_items_sold),
              method = 'lm', formula = y~ns(x, df=2), color="#1b9e77") +
  geom_smooth(data=subset(pullmanNCNU_compare, saledate >= "2016-05-06" & saledate <= "2016-09-21" &
                            product_type=="Extracts"),
              mapping = aes(x=saledate, y=perc_items_sold), 
              method = 'lm', formula = y~ns(x, df=2), color="#1b9e77") +
  geom_smooth(data=subset(pullmanNCNU_compare, saledate >= "2016-09-21" & saledate < "2017-01-01" &
                            product_type=="Extracts"),
              mapping = aes(x=saledate, y=perc_items_sold), 
              method = 'lm', formula = y~ns(x, df=2), color="#1b9e77") +
  facet_grid(towntype_Pullman~product_type, scales = "free") +
  scale_x_date(date_breaks = "3 month", date_labels = "%b") +
  # add lines to designate summer
  geom_vline(xintercept= as.numeric(as.Date('2016-05-06')),
             linetype="dashed", size=0.5, colour="dimgrey")+
  geom_vline(xintercept= as.numeric(as.Date('2016-09-21')),
             linetype="dashed", size=0.5, colour="dimgrey") +
  labs(title=" ", x= 'Sale Date', y = "% of Products Sold")

pullNCNU_usable_perc <- ggplot() +
  geom_smooth(data=subset(pullmanNCNU_compare, saledate >= "2016-01-01" & saledate <= "2016-05-06" &
                            product_type=="Usable"),
              mapping = aes(x=saledate, y=perc_items_sold),
              method = 'lm', formula = y~ns(x, df=2), color="#7570b3") +
  geom_smooth(data=subset(pullmanNCNU_compare, saledate >= "2016-05-06" & saledate <= "2016-08-22" &
                            product_type=="Usable"),
              mapping = aes(x=saledate, y=perc_items_sold), 
              method = 'lm', formula = y~ns(x, df=2), color="#7570b3") +
  geom_smooth(data=subset(pullmanNCNU_compare, saledate >= "2016-08-22" & saledate < "2017-01-01" &
                            product_type=="Usable"),
              mapping = aes(x=saledate, y=perc_items_sold), 
              method = 'lm', formula = y~ns(x, df=2), color="#7570b3") +
  facet_grid(towntype_Pullman~product_type, scales = "free") +
  scale_x_date(date_breaks = "3 month", date_labels = "%b") +
  # add lines to designate summer
  geom_vline(xintercept= as.numeric(as.Date('2016-5-6')),
             linetype="dashed", size=0.5, colour="dimgrey")+
  geom_vline(xintercept= as.numeric(as.Date('2016-8-22')),
             linetype="dashed", size=0.5, colour="dimgrey") +
  labs(title="", x= 'Sale Date', y = "% of Products Sold")

grid.arrange(pullNCNU_usable_perc, pullNCNU_edible_perc, pullNCNU_extract_perc, ncol=3)


### percents with dots 

# percents, with dots, by product type & Pullman vs NCNU
pullmanNCNU_compare %>%
  filter(saledate >= "2016-01-01" & saledate < "2017-01-01" & product_type!="Usable" & perc_items_sold < 0.25) %>%
  ggplot(aes(x=saledate, y=perc_items_sold, color=towntype_Pullman)) +
  geom_point() +
  geom_smooth(data=subset(pullmanNCNU_compare, saledate >= "2016-01-01" & saledate <= "2017-01-01" &
                            towntype_Pullman=="Pullman" & product_type!="Usable"),
             mapping = aes(x=saledate, y=perc_items_sold),
             method = 'loess', color="darkblue") +
  geom_smooth(data=subset(pullmanNCNU_compare, saledate >= "2016-01-01" & saledate <= "2017-01-01" &
                            towntype_Pullman=="noncollege-nonurban" & product_type!="Usable"),
             mapping = aes(x=saledate, y=perc_items_sold),
             method = 'loess', color="red") +
  # geom_smooth(data=subset(pullmanNCNU_compare, saledate >= "2016-05-06" & saledate <= "2016-09-21" &
  #                           product_type=="Edibles"),
  #             mapping = aes(x=saledate, y=perc_items_sold), 
  #             method = 'lm', formula = y~ns(x, df=2), color="#d95f02") +
  # geom_smooth(data=subset(pullmanNCNU_compare, saledate >= "2016-09-21" & saledate < "2017-01-01" &
  #                           product_type=="Edibles"),
  #             mapping = aes(x=saledate, y=perc_items_sold), 
  #             method = 'lm', formula = y~ns(x, df=2), color="#d95f02") +
  facet_grid(~product_type, scales = "free") +
  scale_x_date(date_breaks = "3 month", date_labels = "%b") +
  # add lines to designate summer
  geom_vline(xintercept= as.numeric(as.Date('2016-05-06')),
             linetype="dashed", size=0.5, colour="dimgrey")+
  geom_vline(xintercept= as.numeric(as.Date('2016-09-21')),
             linetype="dashed", size=0.5, colour="dimgrey") +
  labs(title=" ", x= 'Sale Date', y = "% of Products Sold")


pullmanNCNU_compare %>%
  filter(saledate >= "2016-01-01" & saledate < "2017-01-01" & product_type=="Usable") %>%
  ggplot(aes(x=saledate, y=perc_items_sold, color=towntype_Pullman)) +
  geom_point() +
  geom_smooth(data=subset(pullmanNCNU_compare, saledate >= "2016-01-01" & saledate <= "2017-01-01" &
                            towntype_Pullman=="Pullman" & product_type=="Usable"),
             mapping = aes(x=saledate, y=perc_items_sold),
             method = 'loess', color="darkblue") +
  geom_smooth(data=subset(pullmanNCNU_compare, saledate >= "2016-01-01" & saledate <= "2017-01-01" &
                            towntype_Pullman=="noncollege-nonurban" & product_type=="Usable"),
             mapping = aes(x=saledate, y=perc_items_sold),
             method = 'loess', color="red") +
  # geom_smooth(data=subset(pullmanNCNU_compare, saledate >= "2016-05-06" & saledate <= "2016-09-21" &
  #                           product_type=="Edibles"),
  #             mapping = aes(x=saledate, y=perc_items_sold), 
  #             method = 'lm', formula = y~ns(x, df=2), color="#d95f02") +
  # geom_smooth(data=subset(pullmanNCNU_compare, saledate >= "2016-09-21" & saledate < "2017-01-01" &
  #                           product_type=="Edibles"),
  #             mapping = aes(x=saledate, y=perc_items_sold), 
  #             method = 'lm', formula = y~ns(x, df=2), color="#d95f02") +
  facet_grid(~product_type, scales = "free") +
  scale_x_date(date_breaks = "3 month", date_labels = "%b") +
  # add lines to designate summer
  geom_vline(xintercept= as.numeric(as.Date('2016-05-06')),
             linetype="dashed", size=0.5, colour="dimgrey")+
  geom_vline(xintercept= as.numeric(as.Date('2016-09-21')),
             linetype="dashed", size=0.5, colour="dimgrey") +
  labs(title=" ", x= 'Sale Date', y = "% of Products Sold")


pullmanNCNU_compare %>%
  filter(saledate >= "2016-01-01" & saledate < "2017-01-01" & product_type=="Usable") %>%
  ggplot(aes(x=saledate, y=perc_items_sold, color=product_type)) +
  geom_point() +
  geom_smooth(data=subset(pullmanNCNU_compare, saledate >= "2016-01-01" & saledate <= "2017-01-01" &
                            product_type=="Usable"),
             mapping = aes(x=saledate, y=perc_items_sold),
             method = 'loess', color="#d95f02") +
  # geom_smooth(data=subset(pullmanNCNU_compare, saledate >= "2016-05-06" & saledate <= "2016-09-21" &
  #                           product_type=="Edibles"),
  #             mapping = aes(x=saledate, y=perc_items_sold), 
  #             method = 'lm', formula = y~ns(x, df=2), color="#d95f02") +
  # geom_smooth(data=subset(pullmanNCNU_compare, saledate >= "2016-09-21" & saledate < "2017-01-01" &
  #                           product_type=="Edibles"),
  #             mapping = aes(x=saledate, y=perc_items_sold), 
  #             method = 'lm', formula = y~ns(x, df=2), color="#d95f02") +
  facet_grid(towntype_Pullman~product_type, scales = "free") +
  scale_x_date(date_breaks = "3 month", date_labels = "%b") +
  # add lines to designate summer
  geom_vline(xintercept= as.numeric(as.Date('2016-05-06')),
             linetype="dashed", size=0.5, colour="dimgrey")+
  geom_vline(xintercept= as.numeric(as.Date('2016-09-21')),
             linetype="dashed", size=0.5, colour="dimgrey") +
  labs(title=" ", x= 'Sale Date', y = "% of Products Sold")



# items sold, facet for each town + type, not usable
pullNCNU_edible <- ggplot() +
  geom_smooth(data=subset(pullmanNCNU_compare, saledate >= "2016-01-01" & saledate <= "2016-05-06" &
                            product_type=="Edibles"),
              mapping = aes(x=saledate, y=perc_items_sold*tot_items),
              method = 'lm', formula = y~ns(x, df=2), color="#d95f02") +
  geom_smooth(data=subset(pullmanNCNU_compare, saledate >= "2016-05-06" & saledate <= "2016-09-21" &
                            product_type=="Edibles"),
              mapping = aes(x=saledate, y=perc_items_sold*tot_items), 
              method = 'lm', formula = y~ns(x, df=2), color="#d95f02") +
  geom_smooth(data=subset(pullmanNCNU_compare, saledate >= "2016-09-21" & saledate < "2017-01-01" &
                            product_type=="Edibles"),
              mapping = aes(x=saledate, y=perc_items_sold*tot_items), 
              method = 'lm', formula = y~ns(x, df=2), color="#d95f02") +
  facet_grid(towntype_Pullman~product_type, scales = "free") +
  scale_x_date(date_breaks = "3 month", date_labels = "%b") +
  # add lines to designate summer
  geom_vline(xintercept= as.numeric(as.Date('2016-05-06')),
             linetype="dashed", size=0.5, colour="dimgrey")+
  geom_vline(xintercept= as.numeric(as.Date('2016-09-21')),
             linetype="dashed", size=0.5, colour="dimgrey") +
  labs(title=" ", x= 'Sale Date', y = "# of Item-Entries")

pullNCNU_extract <- ggplot() +
  geom_smooth(data=subset(pullmanNCNU_compare, saledate >= "2016-01-01" & saledate <= "2016-05-06" &
                            product_type=="Extracts"),
              mapping = aes(x=saledate, y=perc_items_sold*tot_items),
              method = 'lm', formula = y~ns(x, df=2), color="#1b9e77") +
  geom_smooth(data=subset(pullmanNCNU_compare, saledate >= "2016-05-06" & saledate <= "2016-09-21" &
                            product_type=="Extracts"),
              mapping = aes(x=saledate, y=perc_items_sold*tot_items), 
              method = 'lm', formula = y~ns(x, df=2), color="#1b9e77") +
  geom_smooth(data=subset(pullmanNCNU_compare, saledate >= "2016-09-21" & saledate < "2017-01-01" &
                            product_type=="Extracts"),
              mapping = aes(x=saledate, y=perc_items_sold*tot_items), 
              method = 'lm', formula = y~ns(x, df=2), color="#1b9e77") +
  facet_grid(towntype_Pullman~product_type, scales = "free") +
  scale_x_date(date_breaks = "3 month", date_labels = "%b") +
  # add lines to designate summer
  geom_vline(xintercept= as.numeric(as.Date('2016-05-06')),
             linetype="dashed", size=0.5, colour="dimgrey")+
  geom_vline(xintercept= as.numeric(as.Date('2016-09-21')),
             linetype="dashed", size=0.5, colour="dimgrey") +
  labs(title=" ", x= 'Sale Date', y = "# of Item-Entries")

pullNCNU_usable <- ggplot() +
  geom_smooth(data=subset(pullmanNCNU_compare, saledate >= "2016-01-01" & saledate <= "2016-05-06" &
                            product_type=="Usable"),
              mapping = aes(x=saledate, y=perc_items_sold*tot_items),
              method = 'lm', formula = y~ns(x, df=2), color="#7570b3") +
  geom_smooth(data=subset(pullmanNCNU_compare, saledate >= "2016-05-06" & saledate <= "2016-08-22" &
                            product_type=="Usable"),
              mapping = aes(x=saledate, y=perc_items_sold*tot_items), 
              method = 'lm', formula = y~ns(x, df=2), color="#7570b3") +
  geom_smooth(data=subset(pullmanNCNU_compare, saledate >= "2016-08-22" & saledate < "2017-01-01" &
                            product_type=="Usable"),
              mapping = aes(x=saledate, y=perc_items_sold*tot_items), 
              method = 'lm', formula = y~ns(x, df=2), color="#7570b3") +
  facet_grid(towntype_Pullman~product_type, scales = "free") +
  scale_x_date(date_breaks = "3 month", date_labels = "%b") +
  # add lines to designate summer
  geom_vline(xintercept= as.numeric(as.Date('2016-5-6')),
             linetype="dashed", size=0.5, colour="dimgrey")+
  geom_vline(xintercept= as.numeric(as.Date('2016-8-22')),
             linetype="dashed", size=0.5, colour="dimgrey") +
  labs(title="", x= 'Sale Date', y = "# of Item-Entries")

grid.arrange(pullNCNU_usable, pullNCNU_edible, pullNCNU_extract, ncol=3)
```


### Inhalant types in Pullman

```{r perc_city_noncollege_Pullman}

inhaltypes_pullman <- daily_aggregate_inhaltypes_byTownType %>%
  dplyr::filter(towntype_Pullman=="Pullman") %>%
  dplyr::rename(`Cartridge & Oil` = perc.cart_oil, `Hash & Kief` = perc.hash_kief, `Uncategorized` = perc.uncategorized,
                `Wax, Shatter, Dab, Resin` = perc.wax_shatter_dab_resin) %>%
  tidyr::gather(inhal_group, perc_group, 6:9) %>%
  dplyr::mutate(inhal_group = factor(inhal_group, levels = c("Cartridge & Oil", "Wax, Shatter, Dab, Resin", 
                                                             "Hash & Kief", "Uncategorized"))) %>%
  dplyr::rename(`Inhalant Group` = inhal_group)

inhaltypes_noncollege_nonurban <- daily_aggregate_inhaltypes_byTownType %>%
  dplyr::filter(towntype_Pullman=="noncollege-nonurban") %>%
  dplyr::rename(`Cartridge & Oil` = perc.cart_oil, `Hash & Kief` = perc.hash_kief, `Uncategorized` = perc.uncategorized,
                `Wax, Shatter, Dab, Resin` = perc.wax_shatter_dab_resin) %>%
  tidyr::gather(inhal_group, perc_group, 6:9) %>%
  dplyr::mutate(inhal_group = factor(inhal_group, levels = c("Cartridge & Oil", "Wax, Shatter, Dab, Resin", 
                                                             "Hash & Kief", "Uncategorized"))) %>%
  dplyr::rename(`Inhalant Group` = inhal_group)

inhaltypes_bigcity <- daily_aggregate_inhaltypes_byTownType %>%
  dplyr::filter(towntype_Pullman=="bigcity") %>%
  dplyr::rename(`Cartridge & Oil` = perc.cart_oil, `Hash & Kief` = perc.hash_kief, `Uncategorized` = perc.uncategorized,
                `Wax, Shatter, Dab, Resin` = perc.wax_shatter_dab_resin) %>%
  tidyr::gather(inhal_group, perc_group, 6:9) %>%
  dplyr::mutate(inhal_group = factor(inhal_group, levels = c("Cartridge & Oil", "Wax, Shatter, Dab, Resin", 
                                                             "Hash & Kief", "Uncategorized"))) %>%
  dplyr::rename(`Inhalant Group` = inhal_group)

# straight lines: pullman
inhaltypes_pullman %>%
  ggplot() +
  # different regression lines for spring, summer, and fall
  geom_smooth(data=subset(inhaltypes_pullman, saledate >= "2016-01-01" & saledate <="2016-05-05"),
              mapping = aes(x=saledate, y=perc_group, color=`Inhalant Group`),
              method = 'lm') + 
  geom_smooth(data=subset(inhaltypes_pullman, saledate >= "2016-05-05" & saledate <= "2016-08-22"),
              mapping = aes(x=saledate, y=perc_group, color=`Inhalant Group`),
              method = 'lm') + 
  geom_smooth(data=subset(inhaltypes_pullman, saledate >= "2016-08-22" & saledate < "2017-01-01"),
              mapping = aes(x=saledate, y=perc_group, color=`Inhalant Group`),
              method = 'lm') + 
  scale_colour_brewer(palette = "Set2") +
  # add lines to designate summer
  geom_vline(xintercept= as.numeric(as.Date('2016-5-6')),
             linetype="dashed", size=1, colour="darkgreen")+
  geom_vline(xintercept= as.numeric(as.Date('2016-8-22')),
             linetype="dashed", size=1, colour="darkgreen") +
  labs(title="Pullman Usage by Inhalant Group Types",
       x="Sale Date",
       y="Percent of Inhalant Sales of Each Group")

# degrees of freedom: pullman
pullman_inhal_graph <- inhaltypes_pullman %>%
  ggplot() +
  # different regression lines for spring, summer, and fall
  geom_smooth(data=subset(inhaltypes_pullman, saledate >= "2016-01-01" & saledate <="2016-05-05"),
              mapping = aes(x=saledate, y=perc_group, color=`Inhalant Group`),
              method = 'lm', formula = y~ns(x, df=3)) + 
  geom_smooth(data=subset(inhaltypes_pullman, saledate >= "2016-05-05" & saledate <= "2016-08-22"),
              mapping = aes(x=saledate, y=perc_group, color=`Inhalant Group`),
              method = 'lm', formula = y~ns(x, df=3)) + 
  geom_smooth(data=subset(inhaltypes_pullman, saledate >= "2016-08-22" & saledate < "2017-01-01"),
              mapping = aes(x=saledate, y=perc_group, color=`Inhalant Group`),
              method = 'lm', formula = y~ns(x, df=3)) + 
  scale_colour_brewer(palette = "Set2") +
  # add lines to designate summer
  geom_vline(xintercept= as.numeric(as.Date('2016-5-6')),
             linetype="dashed", size=1, colour="darkgreen")+
  geom_vline(xintercept= as.numeric(as.Date('2016-8-22')),
             linetype="dashed", size=1, colour="darkgreen") +
  labs(title="Pullman Usage by Inhalant Group Types",
       x="Sale Date",
       y="P% Inhalant Sales")


# degrees of freedom: noncollege non urban
nonurban_inhal_graph <- inhaltypes_noncollege_nonurban %>%
  ggplot() +
  # different regression lines for spring, summer, and fall
  geom_smooth(data=subset(inhaltypes_noncollege_nonurban, saledate >= "2016-01-01" & saledate <="2016-05-05"),
              mapping = aes(x=saledate, y=perc_group, color=`Inhalant Group`),
              method = 'lm', formula = y~ns(x, df=3)) + 
  geom_smooth(data=subset(inhaltypes_noncollege_nonurban, saledate >= "2016-05-05" & saledate <= "2016-08-22"),
              mapping = aes(x=saledate, y=perc_group, color=`Inhalant Group`),
              method = 'lm', formula = y~ns(x, df=3)) + 
  geom_smooth(data=subset(inhaltypes_noncollege_nonurban, saledate >= "2016-08-22" & saledate < "2017-01-01"),
              mapping = aes(x=saledate, y=perc_group, color=`Inhalant Group`),
              method = 'lm', formula = y~ns(x, df=3)) + 
  scale_colour_brewer(palette = "Set2") +
  # add lines to designate summer
  geom_vline(xintercept= as.numeric(as.Date('2016-5-6')),
             linetype="dashed", size=1, colour="darkgreen")+
  geom_vline(xintercept= as.numeric(as.Date('2016-8-22')),
             linetype="dashed", size=1, colour="darkgreen") +
  labs(title="Noncollege-Nonurban Usage by Inhalant Group Types",
       x="Sale Date",
       y="% Inhalant Sales")

bigcity_inhal_graph <- ggplot() +
  # different regression lines for spring, summer, and fall
  geom_smooth(data=subset(inhaltypes_bigcity, saledate >= "2016-01-01" & saledate <="2016-05-05"),
              mapping = aes(x=saledate, y=perc_group, color=`Inhalant Group`),
              method = 'lm', formula = y~ns(x, df=3)) + 
  geom_smooth(data=subset(inhaltypes_bigcity, saledate >= "2016-05-05" & saledate <= "2016-08-22"),
              mapping = aes(x=saledate, y=perc_group, color=`Inhalant Group`),
              method = 'lm', formula = y~ns(x, df=3)) + 
  geom_smooth(data=subset(inhaltypes_bigcity, saledate >= "2016-08-22" & saledate < "2017-01-01"),
              mapping = aes(x=saledate, y=perc_group, color=`Inhalant Group`),
              method = 'lm', formula = y~ns(x, df=3)) + 
  scale_colour_brewer(palette = "Set2") +
  # add lines to designate summer
  geom_vline(xintercept= as.numeric(as.Date('2016-5-6')),
             linetype="dashed", size=1, colour="darkgreen")+
  geom_vline(xintercept= as.numeric(as.Date('2016-8-22')),
             linetype="dashed", size=1, colour="darkgreen") +
  labs(title="Big City Usage by Inhalant Group Types",
       x="Sale Date",
       y="% Inhalant Sales")

grid.arrange(pullman_inhal_graph, nonurban_inhal_graph)

grid.arrange(pullman_inhal_graph, nonurban_inhal_graph, bigcity_inhal_graph)
```

```{r placebocities, echo=FALSE, message=FALSE, fig.width=6, fig.height=4.5}

# extracts proportion
pullman_usable <- daily_aggregate %>%
  #filter(collegetown==TRUE) %>%
  #filter(city=="PULLMAN", city=="WALLA WALLA", city=="ELLENSBURG") %>%
  filter(city=="PULLMAN") %>%
  ggplot(aes(x=saledate, y=perc.usable)) +
  geom_point() +
  # different regression lines for spring, summer, and fall
  geom_smooth(data=subset(daily_aggregate, city=="PULLMAN" & saledate <= "2016-05-05"),
              mapping = aes(x=saledate,y=perc.usable),
              method = 'lm',color =  "#CC79A7") +
  geom_smooth(data=subset(daily_aggregate, city=="PULLMAN" & saledate >= "2016-05-05" & 
                            saledate <= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.usable), 
              method = 'lm',color =  "#CC79A7") +
  geom_smooth(data=subset(daily_aggregate, city=="PULLMAN" & saledate >= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.usable), 
              method = 'lm',color =  "#CC79A7") +
  # add lines to designate summer
  geom_vline(xintercept= as.numeric(as.Date('2016-5-6')),
             linetype="dashed", size=1, colour="darkgreen")+
  geom_vline(xintercept= as.numeric(as.Date('2016-8-22')),
             linetype="dashed", size=1, colour="darkgreen") +
  labs(title="Percent of Sales that are Usable, Pullman")

# extracts proportion
seattle_usable <- daily_aggregate %>%
  #filter(collegetown==TRUE) %>%
  #filter(city=="PULLMAN", city=="WALLA WALLA", city=="ELLENSBURG") %>%
  filter(city=="SEATTLE") %>%
  ggplot(aes(x=saledate, y=perc.usable)) +
  geom_point() +
  # different regression lines for spring, summer, and fall
  geom_smooth(data=subset(daily_aggregate, city=="SEATTLE" & saledate <= "2016-05-05"),
              mapping = aes(x=saledate,y=perc.usable),
              method = 'lm',color =  "#CC79A7") +
  geom_smooth(data=subset(daily_aggregate, city=="SEATTLE" & saledate >= "2016-05-05" & 
                            saledate <= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.usable), 
              method = 'lm',color =  "#CC79A7") +
  geom_smooth(data=subset(daily_aggregate, city=="SEATTLE" & saledate >= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.usable), 
              method = 'lm',color =  "#CC79A7") +
  # add lines to designate summer
  geom_vline(xintercept= as.numeric(as.Date("2016-05-05")),
             linetype="dashed", size=1, colour="darkgreen")+
  geom_vline(xintercept= as.numeric(as.Date("2016-08-22")),
             linetype="dashed", size=1, colour="darkgreen") +
  labs(title="Percent of Sales that are Usable, SEATTLE")

everson_usable <- daily_aggregate %>%
  #filter(collegetown==TRUE) %>%
  #filter(city=="PULLMAN", city=="WALLA WALLA", city=="ELLENSBURG") %>%
  filter(city=="EVERSON") %>%
  ggplot(aes(x=saledate, y=perc.usable)) +
  geom_point() +
  # different regression lines for spring, summer, and fall
  geom_smooth(data=subset(daily_aggregate, city=="EVERSON" & saledate <= "2016-05-05"),
              mapping = aes(x=saledate,y=perc.usable),
              method = 'lm',color =  "#CC79A7") +
  geom_smooth(data=subset(daily_aggregate, city=="EVERSON" & saledate >= "2016-05-05" & 
                            saledate <= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.usable), 
              method = 'lm',color =  "#CC79A7") +
  geom_smooth(data=subset(daily_aggregate, city=="EVERSON" & saledate >= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.usable), 
              method = 'lm',color =  "#CC79A7") +
  # add lines to designate summer
  geom_vline(xintercept= as.numeric(as.Date("2016-05-05")),
             linetype="dashed", size=1, colour="darkgreen")+
  geom_vline(xintercept= as.numeric(as.Date("2016-08-22")),
             linetype="dashed", size=1, colour="darkgreen") +
  labs(title="Percent of Sales that are Usable, EVERSON")

grid.arrange(pullman_usable, seattle_usable, everson_usable)




# extracts proportion
daily_aggregate %>%
  #filter(collegetown==TRUE) %>%
  #filter(city=="PULLMAN", city=="WALLA WALLA", city=="ELLENSBURG") %>%
  filter(city=="PULLMAN", city=="EVERSON") %>%
  ggplot(aes(x=saledate, y=perc.usable, group=city)) +
  geom_point() +
  # different regression lines for spring, summer, and fall
  geom_smooth(data=subset(daily_aggregate, city=="PULLMAN" & saledate <= "2016-05-05"),
              mapping = aes(x=saledate,y=perc.usable),
              method = 'lm',color =  "#CC79A7") +
  geom_smooth(data=subset(daily_aggregate, city=="PULLMAN" & saledate >= "2016-05-05" & 
                            saledate <= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.usable), 
              method = 'lm',color =  "#CC79A7") +
  geom_smooth(data=subset(daily_aggregate, city=="PULLMAN" & saledate >= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.usable), 
              method = 'lm',color =  "#CC79A7") +
  # different regression lines for spring, summer, and fall
  geom_smooth(data=subset(daily_aggregate, city=="EVERSON" & saledate <= "2016-05-05"),
              mapping = aes(x=saledate,y=perc.usable),
              method = 'lm',color =  "purple") +
  geom_smooth(data=subset(daily_aggregate, city=="EVERSON" & saledate >= "2016-05-05" & 
                            saledate <= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.usable), 
              method = 'lm',color =  "purple") +
  geom_smooth(data=subset(daily_aggregate, city=="EVERSON" & saledate >= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.usable), 
              method = 'lm',color =  "purple") +
  # add lines to designate summer
  geom_vline(xintercept= as.numeric(as.Date('2016-5-6')),
             linetype="dashed", size=1, colour="darkgreen")+
  geom_vline(xintercept= as.numeric(as.Date('2016-8-22')),
             linetype="dashed", size=1, colour="darkgreen") +
  labs(title="Percent of Sales that are Usable, Pullman Pink, Everton Purple")



# extracts proportion
daily_aggregate %>%
  #filter(collegetown==TRUE) %>%
  #filter(city=="PULLMAN", city=="WALLA WALLA", city=="ELLENSBURG") %>%
  filter(city=="PULLMAN", city=="EVERSON") %>%
  ggplot(aes(x=saledate, y=perc.edible, group=city)) +
  geom_point() +
  # different regression lines for spring, summer, and fall
  geom_smooth(data=subset(daily_aggregate, city=="PULLMAN" & saledate <= "2016-05-05"),
              mapping = aes(x=saledate,y=perc.usable),
              method = 'lm',color =  "#CC79A7") +
  geom_smooth(data=subset(daily_aggregate, city=="PULLMAN" & saledate >= "2016-05-05" & 
                            saledate <= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.usable), 
              method = 'lm',color =  "#CC79A7") +
  geom_smooth(data=subset(daily_aggregate, city=="PULLMAN" & saledate >= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.usable), 
              method = 'lm',color =  "#CC79A7") +
  # different regression lines for spring, summer, and fall
  geom_smooth(data=subset(daily_aggregate, city=="EVERSON" & saledate <= "2016-05-05"),
              mapping = aes(x=saledate,y=perc.usable),
              method = 'lm',color =  "purple") +
  geom_smooth(data=subset(daily_aggregate, city=="EVERSON" & saledate >= "2016-05-05" & 
                            saledate <= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.usable), 
              method = 'lm',color =  "purple") +
  geom_smooth(data=subset(daily_aggregate, city=="EVERSON" & saledate >= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.usable), 
              method = 'lm',color =  "purple") +
  # add lines to designate summer
  geom_vline(xintercept= as.numeric(as.Date('2016-5-6')),
             linetype="dashed", size=1, colour="darkgreen")+
  geom_vline(xintercept= as.numeric(as.Date('2016-8-22')),
             linetype="dashed", size=1, colour="darkgreen") +
  labs(title="Percent of Sales that are Usable, Pullman Pink, Everton Purple")



# extracts proportion
daily_aggregate %>%
  #filter(collegetown==TRUE) %>%
  #filter(city=="PULLMAN", city=="WALLA WALLA", city=="ELLENSBURG") %>%
  filter(city=="PULLMAN", city=="EVERSON") %>%
  ggplot(aes(x=saledate, y=perc.extracts, group=city)) +
  geom_point() +
  # different regression lines for spring, summer, and fall
  geom_smooth(data=subset(daily_aggregate, city=="PULLMAN" & saledate <= "2015-08-01"),
              mapping = aes(x=saledate,y=perc.extracts),
              method = 'lm',color =  "#CC79A7") +
  geom_smooth(data=subset(daily_aggregate, city=="PULLMAN" & saledate >= "2015-08-01" &
                            saledate <="2016-05-05"),
              mapping = aes(x=saledate,y=perc.extracts),
              method = 'lm',color =  "#CC79A7") +
  geom_smooth(data=subset(daily_aggregate, city=="PULLMAN" & saledate >= "2016-05-05" & 
                            saledate <= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.extracts), 
              method = 'lm',color =  "#CC79A7") +
  geom_smooth(data=subset(daily_aggregate, city=="PULLMAN" & saledate >= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.extracts), 
              method = 'lm',color =  "#CC79A7") +
  # different regression lines for spring, summer, and fall
  geom_smooth(data=subset(daily_aggregate, city=="EVERSON" & saledate <= "2015-08-01"),
              mapping = aes(x=saledate,y=perc.extracts),
              method = 'lm',color =  "purple") +
  geom_smooth(data=subset(daily_aggregate, city=="EVERSON" & saledate >= "2015-08-01" &
                            saledate <="2016-05-05"),
              mapping = aes(x=saledate,y=perc.extracts),
              method = 'lm',color =  "purple") +
  geom_smooth(data=subset(daily_aggregate, city=="EVERSON" & saledate >= "2016-05-05" & 
                            saledate <= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.extracts), 
              method = 'lm',color =  "purple") +
  geom_smooth(data=subset(daily_aggregate, city=="EVERSON" & saledate >= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.extracts), 
              method = 'lm',color =  "purple") +
   # different regression lines for spring, summer, and fall
  geom_smooth(data=subset(daily_aggregate, city=="SPOKANE" & saledate <= "2015-08-01"),
              mapping = aes(x=saledate,y=perc.extracts),
              method = 'lm',color =  "red") +
  geom_smooth(data=subset(daily_aggregate, city=="SPOKANE" & saledate >= "2015-08-01" &
                            saledate <="2016-05-05"),
              mapping = aes(x=saledate,y=perc.extracts),
              method = 'lm',color =  "red") +
  geom_smooth(data=subset(daily_aggregate, city=="SPOKANE" & saledate >= "2016-05-05" & 
                            saledate <= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.extracts), 
              method = 'lm',color =  "red") +
  geom_smooth(data=subset(daily_aggregate, city=="SPOKANE" & saledate >= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.extracts), 
              method = 'lm',color =  "red") +
  # add lines to designate summer
  geom_vline(xintercept= as.numeric(as.Date('2015-08-01')),
             linetype="dashed", size=1, colour="darkgreen")+
  geom_vline(xintercept= as.numeric(as.Date('2016-5-6')),
             linetype="dashed", size=1, colour="darkgreen")+
  geom_vline(xintercept= as.numeric(as.Date('2016-8-22')),
             linetype="dashed", size=1, colour="darkgreen") +
  labs(title="Percent of Sales that are Extracts, Pullman Pink, Everton Purple, Spokane Red")



daily_aggregate %>%
  ggplot(aes(x=saledate, y=perc.extracts, group=city)) +
  # different regression lines for spring, summer, and fall
  geom_smooth(data=subset(daily_aggregate, city=="PULLMAN" & saledate >= "2015-08-24" &
                            saledate <= "2015-12-18"),
              mapping = aes(x=saledate,y=perc.extracts),
              method = 'lm',color =  "#CC79A7") +
  geom_smooth(data=subset(daily_aggregate, city=="PULLMAN" & saledate >= "2015-12-18"  &
                            saledate <="2016-01-11"),
              mapping = aes(x=saledate,y=perc.extracts),
              method = 'lm',color =  "#CC79A7") +
  geom_smooth(data=subset(daily_aggregate, city=="PULLMAN" & saledate >= "2016-01-11" &
                            saledate <="2016-05-05"),
              mapping = aes(x=saledate,y=perc.extracts),
              method = 'lm',color =  "#CC79A7") +
  geom_smooth(data=subset(daily_aggregate, city=="PULLMAN" & saledate >= "2016-05-05" & 
                            saledate <= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.extracts), 
              method = 'lm',color =  "#CC79A7") +
  geom_smooth(data=subset(daily_aggregate, city=="PULLMAN" & saledate >= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.extracts), 
              method = 'lm',color =  "#CC79A7") +
  # different regression lines for spring, summer, and fall
  geom_smooth(data=subset(daily_aggregate, city=="EVERSON" & saledate >= "2015-08-24" &
                            saledate <= "2015-12-18"),
              mapping = aes(x=saledate,y=perc.extracts),
              method = 'lm',color =  "purple") +
  geom_smooth(data=subset(daily_aggregate, city=="EVERSON" & saledate >= "2015-12-18"  &
                            saledate <="2016-01-11"),
              mapping = aes(x=saledate,y=perc.extracts),
              method = 'lm',color =  "purple") +
  geom_smooth(data=subset(daily_aggregate, city=="EVERSON" & saledate >= "2016-01-11" &
                            saledate <="2016-05-05"),
              mapping = aes(x=saledate,y=perc.extracts),
              method = 'lm',color =  "purple") +
  geom_smooth(data=subset(daily_aggregate, city=="EVERSON" & saledate >= "2016-05-05" & 
                            saledate <= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.extracts), 
              method = 'lm',color =  "purple") +
  geom_smooth(data=subset(daily_aggregate, city=="EVERSON" & saledate >= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.extracts), 
              method = 'lm',color =  "purple") +
  # different regression lines for spring, summer, and fall
  geom_smooth(data=subset(daily_aggregate, city=="SPOKANE" & saledate >= "2015-08-24" &
                            saledate <= "2015-12-18"),
              mapping = aes(x=saledate,y=perc.extracts),
              method = 'lm',color =  "red") +
  geom_smooth(data=subset(daily_aggregate, city=="SPOKANE" & saledate >= "2015-12-18"  &
                            saledate <="2016-01-11"),
              mapping = aes(x=saledate,y=perc.extracts),
              method = 'lm',color =  "red") +
  geom_smooth(data=subset(daily_aggregate, city=="SPOKANE" & saledate >= "2016-01-11" &
                            saledate <="2016-05-05"),
              mapping = aes(x=saledate,y=perc.extracts),
              method = 'lm',color =  "red") +
  geom_smooth(data=subset(daily_aggregate, city=="SPOKANE" & saledate >= "2016-05-05" & 
                            saledate <= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.extracts), 
              method = 'lm',color =  "red") +
  geom_smooth(data=subset(daily_aggregate, city=="SPOKANE" & saledate >= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.extracts), 
              method = 'lm',color =  "red") +
  # add lines to designate summer
  geom_vline(xintercept= as.numeric(as.Date("2015-12-18")),
             linetype="dashed", size=1, colour="darkgreen")+
  geom_vline(xintercept= as.numeric(as.Date("2016-01-11")),
             linetype="dashed", size=1, colour="darkgreen")+
  geom_vline(xintercept= as.numeric(as.Date('2016-05-06')),
             linetype="dashed", size=1, colour="darkgreen")+
  geom_vline(xintercept= as.numeric(as.Date('2016-08-22')),
             linetype="dashed", size=1, colour="darkgreen") +
  labs(title="Percent of Sales that are Extracts, Pullman Pink, Everton Purple, Spokane Red")



daily_aggregate %>%
  ggplot(aes(x=saledate, y=perc.edible, group=city)) +
  # different regression lines for spring, summer, and fall
  geom_smooth(data=subset(daily_aggregate, city=="PULLMAN" & saledate <= "2015-08-01"),
              mapping = aes(x=saledate,y=perc.edible),
              method = 'lm',color =  "#CC79A7") +
  geom_smooth(data=subset(daily_aggregate, city=="PULLMAN" & saledate >= "2015-08-01" &
                            saledate <="2016-05-05"),
              mapping = aes(x=saledate,y=perc.edible),
              method = 'lm',color =  "#CC79A7") +
  geom_smooth(data=subset(daily_aggregate, city=="PULLMAN" & saledate >= "2016-05-05" & 
                            saledate <= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.edible), 
              method = 'lm',color =  "#CC79A7") +
  geom_smooth(data=subset(daily_aggregate, city=="PULLMAN" & saledate >= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.edible), 
              method = 'lm',color =  "#CC79A7") +
  # different regression lines for spring, summer, and fall
  geom_smooth(data=subset(daily_aggregate, city=="EVERSON" & saledate <= "2015-08-01"),
              mapping = aes(x=saledate,y=perc.edible),
              method = 'lm',color =  "purple") +
  geom_smooth(data=subset(daily_aggregate, city=="EVERSON" & saledate >= "2015-08-01" &
                            saledate <="2016-05-05"),
              mapping = aes(x=saledate,y=perc.edible),
              method = 'lm',color =  "purple") +
  geom_smooth(data=subset(daily_aggregate, city=="EVERSON" & saledate >= "2016-05-05" & 
                            saledate <= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.edible), 
              method = 'lm',color =  "purple") +
  geom_smooth(data=subset(daily_aggregate, city=="EVERSON" & saledate >= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.edible), 
              method = 'lm',color =  "purple") +
   # different regression lines for spring, summer, and fall
  geom_smooth(data=subset(daily_aggregate, city=="SPOKANE" & saledate <= "2015-08-01"),
              mapping = aes(x=saledate,y=perc.edible),
              method = 'lm',color =  "red") +
  geom_smooth(data=subset(daily_aggregate, city=="SPOKANE" & saledate >= "2015-08-01" &
                            saledate <="2016-05-05"),
              mapping = aes(x=saledate,y=perc.edible),
              method = 'lm',color =  "red") +
  geom_smooth(data=subset(daily_aggregate, city=="SPOKANE" & saledate >= "2016-05-05" & 
                            saledate <= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.edible), 
              method = 'lm',color =  "red") +
  geom_smooth(data=subset(daily_aggregate, city=="SPOKANE" & saledate >= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.edible), 
              method = 'lm',color =  "red") +
  # add lines to designate summer
  geom_vline(xintercept= as.numeric(as.Date('2015-08-01')),
             linetype="dashed", size=1, colour="darkgreen")+
  geom_vline(xintercept= as.numeric(as.Date('2016-5-6')),
             linetype="dashed", size=1, colour="darkgreen")+
  geom_vline(xintercept= as.numeric(as.Date('2016-8-22')),
             linetype="dashed", size=1, colour="darkgreen") +
  labs(title="Percent of Sales that are Edibles, Pullman Pink, Everton Purple, Spokane Red")






```

```{r plotting_types, echo=FALSE, message=FALSE, fig.width=6, fig.height=4.5}

# extracts proportion
prod_mix <- daily_aggregate %>%
  filter(city=="SEATTLE") %>%
  tidyr::gather(prod_type, perc, 6:8) %>%
  #filter(collegetown==TRUE) %>%
  #filter(city=="PULLMAN", city=="WALLA WALLA", city=="ELLENSBURG") %>%
  filter(city=="SEATTLE") %>%
  ggplot(aes(x=saledate, y=perc, color=prod_type)) +
  ylim(0,0.15)+
  geom_point() +
  # different regression lines for spring, summer, and fall
  # geom_smooth(data=subset(daily_aggregate, city=="SEATTLE" & saledate <= "2016-05-05"),
  #             mapping = aes(x=saledate,y=perc.usable),
  #             method = 'lm',color =  "#CC79A7") +
  # geom_smooth(data=subset(daily_aggregate, city=="SEATTLE" & saledate >= "2016-05-05" & 
  #                           saledate <= "2016-08-22"),
  #             mapping = aes(x=saledate,y=perc.usable), 
  #             method = 'lm',color =  "#CC79A7") +
  # geom_smooth(data=subset(daily_aggregate, city=="SEATTLE" & saledate >= "2016-08-22"),
  #             mapping = aes(x=saledate,y=perc.usable), 
  #             method = 'lm',color =  "#CC79A7") +
  # add lines to designate summer
  geom_vline(xintercept= as.numeric(as.Date("2016-05-05")),
             linetype="dashed", size=1, colour="darkgreen")+
  geom_vline(xintercept= as.numeric(as.Date("2016-08-22")),
             linetype="dashed", size=1, colour="darkgreen") +
  labs(title="Percent of Sales that are Usable, SEATTLE")


```

# Other College Towns
```{r othercollege}
# Extract cities for comparison
ellensburg <- daily_aggregate[which(daily_aggregate$city == "ELLENSBURG"), c("city", "saledate", "revenue", "tot_items", "avg_price_peritem", "perc.usable", "perc.edible", "perc.extracts")]
airway <- daily_aggregate[which(daily_aggregate$city == "AIRWAY HEIGHTS"), c("city", "saledate", "revenue", "tot_items", "avg_price_peritem", "perc.usable", "perc.edible", "perc.extracts")]
pullman <- daily_aggregate[which(daily_aggregate$city == "PULLMAN"), c("city", "saledate", "revenue", "tot_items", "avg_price_peritem", "perc.usable", "perc.edible", "perc.extracts")]
ncnu <- daily_aggregate_byTownType[which(daily_aggregate_byTownType$towntype_Pullman == "noncollege-nonurban"), ]
colnames(ncnu) <- c("city", "saledate", "revenue", "tot_items", "avg_price_peritem", "perc.usable", "perc.edible", "perc.extracts")
ncnu$city <- "NCNU"

allcollege_compare <- rbind(ncnu, pullman, ellensburg, airway)

allcollege_compare <- allcollege_compare %>%
  dplyr::rename(Usable = perc.usable, Edibles = perc.edible, Extracts = perc.extracts) %>%
  tidyr::gather(product_type, perc_items_sold, 6:8) %>%
  dplyr::mutate(city = factor(city, levels = c("NCNU", "PULLMAN", "ELLENSBURG", "AIRWAY HEIGHTS")))


# items sold, facet for each town + type, not usable
ggplot() +
  geom_smooth(data=subset(allcollege_compare, saledate >= "2016-01-01" & saledate <= "2016-05-06" &
                            product_type!="Usable"),
              mapping = aes(x=saledate, y=perc_items_sold*tot_items, color=product_type, linetype=product_type),
              method = 'lm', formula = y~ns(x, df=2)) +
  geom_smooth(data=subset(allcollege_compare, saledate >= "2016-06-09" & saledate <= "2016-08-22" &
                            product_type!="Usable"),
              mapping = aes(x=saledate, y=perc_items_sold*tot_items, color=product_type, linetype=product_type), 
              method = 'lm', formula = y~ns(x, df=2)) +
  geom_smooth(data=subset(allcollege_compare, saledate >= "2016-09-21" & saledate < "2017-01-01" &
                            product_type!="Usable"),
              mapping = aes(x=saledate, y=perc_items_sold*tot_items, color=product_type, linetype=product_type), 
              method = 'lm', formula = y~ns(x, df=2)) +
  facet_grid(city~product_type, scales = "free_y") +
  scale_x_date(date_breaks = "3 month", date_labels = "%b") +
    # add lines to designate summer
  geom_vline(xintercept= as.numeric(as.Date('2016-05-05')),
             linetype="dashed", size=0.5, colour="gray")+
  geom_vline(xintercept= as.numeric(as.Date('2016-06-09')),
             linetype="dashed", size=0.5, colour="gray")+
  geom_vline(xintercept= as.numeric(as.Date('2016-08-22')),
             linetype="dashed", size=0.5, colour="gray")+
  geom_vline(xintercept= as.numeric(as.Date('2016-09-21')),
             linetype="dashed", size=0.5, colour="gray") +
  labs(title="# of Item-Entries", x= 'Sale Date', y = "# of Item-Entries of Product")

# items sold, facet for each town + type, only usable
usable_compare <- ggplot() +
  geom_smooth(data=subset(allcollege_compare, saledate >= "2016-01-01" & saledate <= "2016-05-06" &
                            product_type=="Usable"),
              mapping = aes(x=saledate, y=perc_items_sold*tot_items),
              method = 'lm', formula = y~ns(x, df=2), color="#7570b3") +
  geom_smooth(data=subset(allcollege_compare, saledate >= "2016-06-09" & saledate <= "2016-08-22" &
                            product_type=="Usable"),
              mapping = aes(x=saledate, y=perc_items_sold*tot_items), 
              method = 'lm', formula = y~ns(x, df=2), color="#7570b3") +
  geom_smooth(data=subset(allcollege_compare, saledate >= "2016-09-21" & saledate < "2017-01-01" &
                            product_type=="Usable"),
              mapping = aes(x=saledate, y=perc_items_sold*tot_items), 
              method = 'lm', formula = y~ns(x, df=2), color="#7570b3") +
  facet_grid(city~product_type, scales = "free_y") +
  scale_x_date(date_breaks = "3 month", date_labels = "%b") +
    # add lines to designate summer
  geom_vline(xintercept= as.numeric(as.Date('2016-05-05')),
             linetype="dashed", size=0.5, colour="gray")+
  geom_vline(xintercept= as.numeric(as.Date('2016-06-09')),
             linetype="dashed", size=0.5, colour="gray")+
  geom_vline(xintercept= as.numeric(as.Date('2016-08-22')),
             linetype="dashed", size=0.5, colour="gray")+
  geom_vline(xintercept= as.numeric(as.Date('2016-09-21')),
             linetype="dashed", size=0.5, colour="gray") +
  labs(title=" ", x= 'Sale Date', y = "# of Item-Entries of Product")


# items sold, facet for each town + type, only edible
edible_compare <- ggplot() +
  geom_smooth(data=subset(allcollege_compare, saledate >= "2016-01-01" & saledate <= "2016-05-06" &
                            product_type=="Edibles"),
              mapping = aes(x=saledate, y=perc_items_sold*tot_items),
              method = 'lm', formula = y~ns(x, df=2), color="#d95f02") +
  geom_smooth(data=subset(allcollege_compare, saledate >= "2016-06-09" & saledate <= "2016-08-22" &
                            product_type=="Edibles"),
              mapping = aes(x=saledate, y=perc_items_sold*tot_items), 
              method = 'lm', formula = y~ns(x, df=2), color="#d95f02") +
  geom_smooth(data=subset(allcollege_compare, saledate >= "2016-09-21" & saledate < "2017-01-01" &
                            product_type=="Edibles"),
              mapping = aes(x=saledate, y=perc_items_sold*tot_items), 
              method = 'lm', formula = y~ns(x, df=2), color="#d95f02") +
  facet_grid(city~product_type, scales = "free_y") +
  scale_x_date(date_breaks = "3 month", date_labels = "%b") +
    # add lines to designate summer
  geom_vline(xintercept= as.numeric(as.Date('2016-05-05')),
             linetype="dashed", size=0.5, colour="gray")+
  geom_vline(xintercept= as.numeric(as.Date('2016-06-09')),
             linetype="dashed", size=0.5, colour="gray")+
  geom_vline(xintercept= as.numeric(as.Date('2016-08-22')),
             linetype="dashed", size=0.5, colour="gray")+
  geom_vline(xintercept= as.numeric(as.Date('2016-09-21')),
             linetype="dashed", size=0.5, colour="gray") +
  labs(title=" ", x= 'Sale Date', y = " ")

# items sold, facet for each town + type, only Extracts
extracts_compare <- ggplot() +
  geom_smooth(data=subset(allcollege_compare, saledate >= "2016-01-01" & saledate <= "2016-05-06" &
                            product_type=="Extracts"),
              mapping = aes(x=saledate, y=perc_items_sold*tot_items),
              method = 'lm', formula = y~ns(x, df=2), color="#1b9e77") +
  geom_smooth(data=subset(allcollege_compare, saledate >= "2016-06-09" & saledate <= "2016-08-22" &
                            product_type=="Extracts"),
              mapping = aes(x=saledate, y=perc_items_sold*tot_items), 
              method = 'lm', formula = y~ns(x, df=2), color="#1b9e77") +
  geom_smooth(data=subset(allcollege_compare, saledate >= "2016-09-21" & saledate < "2017-01-01" &
                            product_type=="Extracts"),
              mapping = aes(x=saledate, y=perc_items_sold*tot_items), 
              method = 'lm', formula = y~ns(x, df=2), color="#1b9e77") +
  facet_grid(city~product_type, scales = "free_y") +
  scale_x_date(date_breaks = "3 month", date_labels = "%b") +
    # add lines to designate summer
  geom_vline(xintercept= as.numeric(as.Date('2016-05-05')),
             linetype="dashed", size=0.5, colour="gray")+
  geom_vline(xintercept= as.numeric(as.Date('2016-06-09')),
             linetype="dashed", size=0.5, colour="gray")+
  geom_vline(xintercept= as.numeric(as.Date('2016-08-22')),
             linetype="dashed", size=0.5, colour="gray")+
  geom_vline(xintercept= as.numeric(as.Date('2016-09-21')),
             linetype="dashed", size=0.5, colour="gray") +
  labs(title=" ", x= 'Sale Date', y = " ")

grid.arrange(usable_compare, edible_compare, extracts_compare, ncol=3)



# % of product sold, facet for each town + type, only usable
usable_perc_compare <- ggplot() +
  geom_smooth(data=subset(allcollege_compare, saledate >= "2016-01-01" & saledate <= "2016-05-06" &
                            product_type=="Usable"),
              mapping = aes(x=saledate, y=perc_items_sold),
              method = 'lm', formula = y~ns(x, df=2), color="#7570b3") +
  geom_smooth(data=subset(allcollege_compare, saledate >= "2016-06-09" & saledate <= "2016-08-22" &
                            product_type=="Usable"),
              mapping = aes(x=saledate, y=perc_items_sold), 
              method = 'lm', formula = y~ns(x, df=2), color="#7570b3") +
  geom_smooth(data=subset(allcollege_compare, saledate >= "2016-09-21" & saledate < "2017-01-01" &
                            product_type=="Usable"),
              mapping = aes(x=saledate, y=perc_items_sold), 
              method = 'lm', formula = y~ns(x, df=2), color="#7570b3") +
  facet_grid(city~product_type, scales = "free_y") +
  scale_x_date(date_breaks = "3 month", date_labels = "%b") +
    # add lines to designate summer
  geom_vline(xintercept= as.numeric(as.Date('2016-05-05')),
             linetype="dashed", size=0.5, colour="gray")+
  geom_vline(xintercept= as.numeric(as.Date('2016-06-09')),
             linetype="dashed", size=0.5, colour="gray")+
  geom_vline(xintercept= as.numeric(as.Date('2016-08-22')),
             linetype="dashed", size=0.5, colour="gray")+
  geom_vline(xintercept= as.numeric(as.Date('2016-09-21')),
             linetype="dashed", size=0.5, colour="gray") +
  labs(title=" ", x= 'Sale Date', y = "Percent of Products Sold")


# percent of items sold, facet for each town + type, only edible
edible_perc_compare <- ggplot() +
  geom_smooth(data=subset(allcollege_compare, saledate >= "2016-01-01" & saledate <= "2016-05-06" &
                            product_type=="Edibles"),
              mapping = aes(x=saledate, y=perc_items_sold),
              method = 'lm', formula = y~ns(x, df=2), color="#d95f02") +
  geom_smooth(data=subset(allcollege_compare, saledate >= "2016-06-09" & saledate <= "2016-08-22" &
                            product_type=="Edibles"),
              mapping = aes(x=saledate, y=perc_items_sold), 
              method = 'lm', formula = y~ns(x, df=2), color="#d95f02") +
  geom_smooth(data=subset(allcollege_compare, saledate >= "2016-09-21" & saledate < "2017-01-01" &
                            product_type=="Edibles"),
              mapping = aes(x=saledate, y=perc_items_sold), 
              method = 'lm', formula = y~ns(x, df=2), color="#d95f02") +
  facet_grid(city~product_type, scales = "free_y") +
  scale_x_date(date_breaks = "3 month", date_labels = "%b") +
    # add lines to designate summer
  geom_vline(xintercept= as.numeric(as.Date('2016-05-05')),
             linetype="dashed", size=0.5, colour="gray")+
  geom_vline(xintercept= as.numeric(as.Date('2016-06-09')),
             linetype="dashed", size=0.5, colour="gray")+
  geom_vline(xintercept= as.numeric(as.Date('2016-08-22')),
             linetype="dashed", size=0.5, colour="gray")+
  geom_vline(xintercept= as.numeric(as.Date('2016-09-21')),
             linetype="dashed", size=0.5, colour="gray") +
  labs(title=" ", x= 'Sale Date', y = " ")

# percent of items sold, facet for each town + type, only Extracts
extracts_perc_compare <- ggplot() +
  geom_smooth(data=subset(allcollege_compare, saledate >= "2016-01-01" & saledate <= "2016-05-06" &
                            product_type=="Extracts"),
              mapping = aes(x=saledate, y=perc_items_sold),
              method = 'lm', formula = y~ns(x, df=2), color="#1b9e77") +
  geom_smooth(data=subset(allcollege_compare, saledate >= "2016-06-09" & saledate <= "2016-08-22" &
                            product_type=="Extracts"),
              mapping = aes(x=saledate, y=perc_items_sold), 
              method = 'lm', formula = y~ns(x, df=2), color="#1b9e77") +
  geom_smooth(data=subset(allcollege_compare, saledate >= "2016-09-21" & saledate < "2017-01-01" &
                            product_type=="Extracts"),
              mapping = aes(x=saledate, y=perc_items_sold), 
              method = 'lm', formula = y~ns(x, df=2), color="#1b9e77") +
  facet_grid(city~product_type, scales = "free_y") +
  scale_x_date(date_breaks = "3 month", date_labels = "%b") +
    # add lines to designate summer
  geom_vline(xintercept= as.numeric(as.Date('2016-05-05')),
             linetype="dashed", size=0.5, colour="gray")+
  geom_vline(xintercept= as.numeric(as.Date('2016-06-09')),
             linetype="dashed", size=0.5, colour="gray")+
  geom_vline(xintercept= as.numeric(as.Date('2016-08-22')),
             linetype="dashed", size=0.5, colour="gray")+
  geom_vline(xintercept= as.numeric(as.Date('2016-09-21')),
             linetype="dashed", size=0.5, colour="gray") +
  labs(title=" ", x= 'Sale Date', y = " ")

grid.arrange(usable_perc_compare, edible_perc_compare, extracts_perc_compare, ncol=3)


# % type sold, facet for each town + type, not usable
ggplot() +
  geom_smooth(data=subset(allcollege_compare, saledate >= "2016-01-01" & saledate <= "2016-05-06" &
                            product_type!="Usable"),
              mapping = aes(x=saledate, y=perc_items_sold, color=product_type, linetype=product_type),
              method = 'lm', formula = y~ns(x, df=3)) +
  geom_smooth(data=subset(allcollege_compare, saledate >= "2016-06-09" & saledate <= "2016-08-22" &
                            product_type!="Usable"),
              mapping = aes(x=saledate, y=perc_items_sold, color=product_type, linetype=product_type), 
              method = 'lm', formula = y~ns(x, df=3)) +
  geom_smooth(data=subset(allcollege_compare, saledate >= "2016-09-21" & saledate < "2017-01-01" &
                            product_type!="Usable"),
              mapping = aes(x=saledate, y=perc_items_sold, color=product_type, linetype=product_type), 
              method = 'lm', formula = y~ns(x, df=3)) +
  facet_grid(city~product_type, scales = "free_y") +
  scale_x_date(date_breaks = "3 month", date_labels = "%b") +
    # add lines to designate summer
  geom_vline(xintercept= as.numeric(as.Date('2016-05-05')),
             linetype="dashed", size=0.5, colour="gray")+
  geom_vline(xintercept= as.numeric(as.Date('2016-06-09')),
             linetype="dashed", size=0.5, colour="gray")+
  geom_vline(xintercept= as.numeric(as.Date('2016-08-22')),
             linetype="dashed", size=0.5, colour="gray")+
  geom_vline(xintercept= as.numeric(as.Date('2016-09-21')),
             linetype="dashed", size=0.5, colour="gray") +
  labs(title="% of Sales of Each Product Type", x= 'Sale Date', y = "% of Sales")

## using percents
ggplot() +
  geom_smooth(data=subset(allcollege_compare, saledate >= "2016-01-01" & saledate <= "2016-05-06"),
              mapping = aes(x=saledate, y=perc_items_sold, color=product_type, linetype=product_type),
              method = 'lm', formula = y~ns(x, df=2)) +
  geom_smooth(data=subset(allcollege_compare, saledate >= "2016-06-09" & saledate <= "2016-08-22"),
              mapping = aes(x=saledate, y=perc_items_sold, color=product_type, linetype=product_type), 
              method = 'lm', formula = y~ns(x, df=2)) +
  geom_smooth(data=subset(allcollege_compare, saledate >= "2016-09-21" & saledate < "2017-01-01"),
              mapping = aes(x=saledate, y=perc_items_sold, color=product_type, linetype=product_type), 
              method = 'lm', formula = y~ns(x, df=2)) +
  facet_wrap("city", scales = "free", ncol=2) +
  scale_x_date(date_breaks = "3 month", date_labels = "%b") +
    # add lines to designate summer
  geom_vline(xintercept= as.numeric(as.Date('2016-05-05')),
             linetype="dashed", size=0.5, colour="gray")+
  geom_vline(xintercept= as.numeric(as.Date('2016-06-09')),
             linetype="dashed", size=0.5, colour="gray")+
  geom_vline(xintercept= as.numeric(as.Date('2016-08-22')),
             linetype="dashed", size=0.5, colour="gray")+
  geom_vline(xintercept= as.numeric(as.Date('2016-09-21')),
             linetype="dashed", size=0.5, colour="gray") +
  labs(title="% of Products Sold", x= 'Sale Date', y = "% of Products Sold")


## percents, one graph per town
ggplot() +
  geom_smooth(data=subset(allcollege_compare, saledate >= "2016-01-01" & saledate <= "2016-05-06" &
                            product_type!="Usable"),
              mapping = aes(x=saledate, y=perc_items_sold, color=product_type, linetype=product_type),
              method = 'lm', formula = y~ns(x, df=2)) +
  geom_smooth(data=subset(allcollege_compare, saledate >= "2016-06-09" & saledate <= "2016-08-22" &
                            product_type!="Usable"),
              mapping = aes(x=saledate, y=perc_items_sold, color=product_type, linetype=product_type), 
              method = 'lm', formula = y~ns(x, df=2)) +
  geom_smooth(data=subset(allcollege_compare, saledate >= "2016-09-21" & saledate < "2017-01-01" &
                            product_type!="Usable"),
              mapping = aes(x=saledate, y=perc_items_sold, color=product_type, linetype=product_type), 
              method = 'lm', formula = y~ns(x, df=2)) +
  facet_wrap("city", scales = "free", ncol=2) +
  scale_x_date(date_breaks = "3 month", date_labels = "%b") +
    # add lines to designate summer
  geom_vline(xintercept= as.numeric(as.Date('2016-05-05')),
             linetype="dashed", size=0.5, colour="gray")+
  geom_vline(xintercept= as.numeric(as.Date('2016-06-09')),
             linetype="dashed", size=0.5, colour="gray")+
  geom_vline(xintercept= as.numeric(as.Date('2016-08-22')),
             linetype="dashed", size=0.5, colour="gray")+
  geom_vline(xintercept= as.numeric(as.Date('2016-09-21')),
             linetype="dashed", size=0.5, colour="gray") +
  labs(title="% of Products Sold", x= 'Sale Date', y = "% of Products Sold")


## sales, one graph per town
ggplot() +
  geom_smooth(data=subset(allcollege_compare, saledate >= "2016-01-01" & saledate <= "2016-05-06" &
                            product_type!="Usable"),
              mapping = aes(x=saledate, y=perc_items_sold*tot_items, color=product_type, linetype=product_type),
              method = 'lm', formula = y~ns(x, df=2)) +
  geom_smooth(data=subset(allcollege_compare, saledate >= "2016-06-09" & saledate <= "2016-08-22" &
                            product_type!="Usable"),
              mapping = aes(x=saledate, y=perc_items_sold*tot_items, color=product_type, linetype=product_type), 
              method = 'lm', formula = y~ns(x, df=2)) +
  geom_smooth(data=subset(allcollege_compare, saledate >= "2016-09-21" & saledate < "2017-01-01" &
                            product_type!="Usable"),
              mapping = aes(x=saledate, y=perc_items_sold*tot_items, color=product_type, linetype=product_type), 
              method = 'lm', formula = y~ns(x, df=2)) +
  facet_wrap("city", scales = "free", ncol=2) +
  scale_x_date(date_breaks = "3 month", date_labels = "%b") +
    # add lines to designate summer
  geom_vline(xintercept= as.numeric(as.Date('2016-05-05')),
             linetype="dashed", size=0.5, colour="gray")+
  geom_vline(xintercept= as.numeric(as.Date('2016-06-09')),
             linetype="dashed", size=0.5, colour="gray")+
  geom_vline(xintercept= as.numeric(as.Date('2016-08-22')),
             linetype="dashed", size=0.5, colour="gray")+
  geom_vline(xintercept= as.numeric(as.Date('2016-09-21')),
             linetype="dashed", size=0.5, colour="gray") +
  labs(title="# of Item-Entries", x= 'Sale Date', y = "# of Item-Entries of Product")


ncnu$saledate <- as.Date(ncnu$saledate)


```


### Ellensburg

```{r ellensburg}
# Extract Ellensburg
ellensburg <- daily_aggregate[which(daily_aggregate$city == "ELLENSBURG"), c("city", "saledate", "revenue", "tot_items", "avg_price_peritem", "perc.usable", "perc.edible", "perc.extracts")]

# Get the non-college non-urban aggregation
ncnu <- daily_aggregate_byTownType[which(daily_aggregate_byTownType$towntype_Pullman == "noncollege-nonurban"), ]
colnames(ncnu) <- c("city", "saledate", "revenue", "tot_items", "avg_price_peritem", "perc.usable", "perc.edible", "perc.extracts")
ncnu$saledate <- as.Date(ncnu$saledate)

ellensburg.fg1 <- rbind(ncnu, ellensburg)

# Create the graph
# Usable
ellensburg.usable <- ggplot() +
   # different regression lines for spring, summer, and fall
  geom_smooth(data=subset(ellensburg.fg1, saledate >= "2016-01-01" &
                            saledate <= "2016-06-09"),
              mapping = aes(x=saledate, y=perc.usable*tot_items),
              method = 'lm', formula = y~ns(x, df=2), color =  "#7570b3") +
  geom_smooth(data=subset(ellensburg.fg1, saledate >= "2016-06-09" & 
                            saledate <= "2016-09-21"),
              mapping = aes(x=saledate, y=perc.usable*tot_items), 
              method = 'lm', formula = y~ns(x, df=2), color =  "#7570b3") +
  geom_smooth(data=subset(ellensburg.fg1, saledate >= "2016-09-21"),
              mapping = aes(x=saledate, y=perc.usable*tot_items), 
              method = 'lm', formula = y~ns(x, df=2), color =  "#7570b3") +
    facet_wrap(~city, nrow=2,scales = "free_y") +
  scale_x_date(date_breaks = "1 month", date_labels = "%b") +
    # add lines to designate summer
  geom_vline(xintercept= as.numeric(as.Date('2016-06-09')),
             linetype="dashed", size=1, colour="darkgreen")+
  geom_vline(xintercept= as.numeric(as.Date('2016-09-21')),
             linetype="dashed", size=1, colour="darkgreen") +
  labs(title="Usable", x= 'Sale Date', y = "")

# Extracts
ellensburg.extracts <- ggplot() +
   # different regression lines for spring, summer, and fall
  geom_smooth(data=subset(ellensburg.fg1, saledate >= "2016-01-01" &
                            saledate <= "2016-06-09"),
              mapping = aes(x=saledate, y=perc.extracts*tot_items),
              method = 'lm', formula = y~ns(x, df=2), color =  "#7570b3") +
  geom_smooth(data=subset(ellensburg.fg1, saledate >= "2016-06-09" & 
                            saledate <= "2016-09-21"),
              mapping = aes(x=saledate, y=perc.extracts*tot_items), 
              method = 'lm', formula = y~ns(x, df=2), color =  "#7570b3") +
  geom_smooth(data=subset(ellensburg.fg1, saledate >= "2016-09-21"),
              mapping = aes(x=saledate, y=perc.extracts*tot_items), 
              method = 'lm', formula = y~ns(x, df=2), color =  "#7570b3") +
    facet_wrap(~city,nrow=2,scales = "free_y") +
  scale_x_date(date_breaks = "1 month", date_labels = "%b") +
    # add lines to designate summer
  geom_vline(xintercept= as.numeric(as.Date('2016-06-09')),
             linetype="dashed", size=1, colour="darkgreen")+
  geom_vline(xintercept= as.numeric(as.Date('2016-09-21')),
             linetype="dashed", size=1, colour="darkgreen") +
  labs(title="Extracts", x= 'Sale Date', y = '')

# Edible
ellensburg.edible <- ggplot() +
   # different regression lines for spring, summer, and fall
  geom_smooth(data=subset(ellensburg.fg1, saledate >= "2016-01-01" &
                            saledate <= "2016-06-09"),
              mapping = aes(x=saledate, y=perc.edible*tot_items),
              method = 'lm', formula = y~ns(x, df=2), color =  "#7570b3") +
  geom_smooth(data=subset(ellensburg.fg1, saledate >= "2016-06-09" & 
                            saledate <= "2016-09-21"),
              mapping = aes(x=saledate, y=perc.edible*tot_items), 
              method = 'lm', formula = y~ns(x, df=2), color =  "#7570b3") +
  geom_smooth(data=subset(ellensburg.fg1, saledate >= "2016-09-21"),
              mapping = aes(x=saledate, y=perc.edible*tot_items), 
              method = 'lm', formula = y~ns(x, df=2), color =  "#7570b3") +
    facet_wrap(~city,nrow=2,scales = "free_y") +
  scale_x_date(date_breaks = "1 month", date_labels = "%b") +
    # add lines to designate summer
  geom_vline(xintercept= as.numeric(as.Date('2016-06-09')),
             linetype="dashed", size=1, colour="darkgreen")+
  geom_vline(xintercept= as.numeric(as.Date('2016-09-21')),
             linetype="dashed", size=1, colour="darkgreen") +
  labs(title="Edible", x= 'Sale Date', y = '')

# Put 3 graphs together
grid.arrange(ellensburg.usable, ellensburg.extracts, ellensburg.edible, ncol = 3)

```

## 
Airway Heights - Eastern Washington University

```{r airwayheights}

# Extract Airway Heights
airway <- daily_aggregate[which(daily_aggregate$city == "AIRWAY HEIGHTS"), c("city", "saledate", "revenue", "tot_items", "avg_price_peritem", "perc.usable", "perc.edible", "perc.extracts")]
airway.fg1 <- rbind(ncnu, airway)

# Create the graph
# Usable
airway.usable <- ggplot() +
   # different regression lines for spring, summer, and fall
  geom_smooth(data=subset(airway.fg1, saledate >= "2016-01-01" &
                            saledate <= "2016-05-06"),
              mapping = aes(x=saledate, y=perc.usable*tot_items),
              method = 'lm', formula = y~ns(x, df=2), color =  "#7570b3") +
  geom_smooth(data=subset(airway.fg1, saledate >= "2016-05-06" & 
                            saledate <= "2016-08-22"),
              mapping = aes(x=saledate, y=perc.usable*tot_items), 
              method = 'lm', formula = y~ns(x, df=2), color =  "#7570b3") +
  geom_smooth(data=subset(airway.fg1, saledate >= "2016-08-22" & saledate < "2017-01-01"),
              mapping = aes(x=saledate, y=perc.usable*tot_items), 
              method = 'lm', formula = y~ns(x, df=2), color =  "#7570b3") +
    facet_wrap(~city, nrow=2,scales = "free_y") +
  scale_x_date(date_breaks = "1 month", date_labels = "%b") +
    # add lines to designate summer
  geom_vline(xintercept= as.numeric(as.Date('2016-05-06')),
             linetype="dashed", size=1, colour="darkgreen")+
  geom_vline(xintercept= as.numeric(as.Date('2016-08-22')),
             linetype="dashed", size=1, colour="darkgreen")+
  labs(title="Usable", x= 'Sale Date', y = "")

# Extracts
airway.extracts <- ggplot() +
   # different regression lines for spring, summer, and fall
  geom_smooth(data=subset(airway.fg1, saledate >= "2016-01-01" &
                            saledate <= "2016-05-06"),
              mapping = aes(x=saledate, y=perc.extracts*tot_items),
              method = 'lm', formula = y~ns(x, df=2), color =  "#7570b3") +
  geom_smooth(data=subset(airway.fg1, saledate >= "2016-05-06" & 
                            saledate <= "2016-08-22"),
              mapping = aes(x=saledate, y=perc.extracts*tot_items), 
              method = 'lm', formula = y~ns(x, df=2), color =  "#7570b3") +
  geom_smooth(data=subset(airway.fg1, saledate >= "2016-08-22" & saledate < "2017-01-01"),
              mapping = aes(x=saledate, y=perc.extracts*tot_items), 
              method = 'lm', formula = y~ns(x, df=2), color =  "#7570b3") +
    facet_wrap(~city, nrow=2,scales = "free_y") +
  scale_x_date(date_breaks = "1 month", date_labels = "%b") +
    # add lines to designate summer
  geom_vline(xintercept= as.numeric(as.Date('2016-05-06')),
             linetype="dashed", size=1, colour="darkgreen")+
  geom_vline(xintercept= as.numeric(as.Date('2016-08-22')),
             linetype="dashed", size=1, colour="darkgreen")+
  labs(title="Extracts", x= 'Sale Date', y = '')

# Edible
airway.edible <- ggplot() +
   # different regression lines for spring, summer, and fall
  geom_smooth(data=subset(airway.fg1, saledate >= "2016-01-01" &
                            saledate <= "2016-05-06"),
              mapping = aes(x=saledate, y=perc.edible*tot_items),
              method = 'lm', formula = y~ns(x, df=2), color =  "#7570b3") +
  geom_smooth(data=subset(airway.fg1, saledate >= "2016-05-06" & 
                            saledate <= "2016-08-22"),
              mapping = aes(x=saledate, y=perc.edible*tot_items), 
              method = 'lm', formula = y~ns(x, df=2), color =  "#7570b3") +
  geom_smooth(data=subset(airway.fg1, saledate >= "2016-08-22" & saledate < "2017-01-01"),
              mapping = aes(x=saledate, y=perc.edible*tot_items), 
              method = 'lm', formula = y~ns(x, df=2), color =  "#7570b3") +
    facet_wrap(~city, nrow=2,scales = "free_y") +
  scale_x_date(date_breaks = "2 month", date_labels = "%b") +
    # add lines to designate summer
  geom_vline(xintercept= as.numeric(as.Date('2016-05-06')),
             linetype="dashed", size=1, colour="darkgreen")+
  geom_vline(xintercept= as.numeric(as.Date('2016-08-22')),
             linetype="dashed", size=1, colour="darkgreen")+
  labs(title="Edible", x= 'Sale Date', y = '')

# Put 3 graphs together
grid.arrange(airway.usable, airway.extracts, airway.edible, ncol = 3)

```




```{r agg_collegetown_notcollege, echo=FALSE, message=FALSE, fig.width=6, fig.height=4.5}

# percent usable
daily_aggregate_bycollegeBoolean %>%
  filter(!collegetown) %>%
  #filter(city=="PULLMAN", city=="WALLA WALLA", city=="ELLENSBURG") %>%
  ggplot(aes(x=saledate, y=perc.usable)) +
  geom_point() +
  # different regression lines for spring, summer, and fall
  geom_smooth(data=subset(daily_aggregate_bycollegeBoolean, !collegetown
                          & saledate <= "2016-05-05"),
              mapping = aes(x=saledate,y=perc.usable),
              method = 'lm',color =  "#CC79A7") +
  geom_smooth(data=subset(daily_aggregate_bycollegeBoolean, !collegetown
                          & saledate >= "2016-05-05" & 
                            saledate <= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.usable), 
              method = 'lm', color =  "#CC79A7") +
  geom_smooth(data=subset(daily_aggregate_bycollegeBoolean, !collegetown
                          & saledate >= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.usable), 
              method = 'lm',color =  "#CC79A7") +
  # add lines to designate summer
  geom_vline(xintercept= as.numeric(as.Date('2016-5-6')),
             linetype="dashed", size=1, colour="darkgreen")+
  geom_vline(xintercept= as.numeric(as.Date('2016-8-22')),
             linetype="dashed", size=1, colour="darkgreen") +
  labs(title="Percent Usable")


# percent usable
daily_aggregate_bycollegeBoolean %>%
  filter(!collegetown) %>%
  #filter(city=="PULLMAN", city=="WALLA WALLA", city=="ELLENSBURG") %>%
  ggplot(aes(x=saledate, y=avg_price_peritem)) +
  geom_point() +
  # different regression lines for spring, summer, and fall
  geom_smooth(data=subset(daily_aggregate_bycollegeBoolean, !collegetown
                          & saledate <= "2016-05-05"),
              mapping = aes(x=saledate,y=avg_price_peritem),
              method = 'lm',color =  "#CC79A7") +
  geom_smooth(data=subset(daily_aggregate_bycollegeBoolean, !collegetown
                          & saledate >= "2016-05-05" & 
                            saledate <= "2016-08-22"),
              mapping = aes(x=saledate,y=avg_price_peritem), 
              method = 'lm', color =  "#CC79A7") +
  geom_smooth(data=subset(daily_aggregate_bycollegeBoolean, !collegetown
                          & saledate >= "2016-08-22"),
              mapping = aes(x=saledate,y=avg_price_peritem), 
              method = 'lm',color =  "#CC79A7") +
  # add lines to designate summer
  geom_vline(xintercept= as.numeric(as.Date('2016-5-6')),
             linetype="dashed", size=1, colour="darkgreen")+
  geom_vline(xintercept= as.numeric(as.Date('2016-8-22')),
             linetype="dashed", size=1, colour="darkgreen") +
  labs(title="Avg price per item")

```


```{r did, echo=FALSE, message=FALSE, fig.width=6, fig.height=4.5}

did_pullman_seattle <- daily_aggregate %>%
  filter(city=="PULLMAN" | city=="SEATTLE") %>%
  mutate(college = ifelse(city=="PULLMAN", 1, 0),
         beforeSummer = ifelse(saledate >= "2016-04-10" & saledate <= "2016-04-16", 0,
                              ifelse(saledate >= "2016-05-22" & saledate <= "2016-05-28", 1,
                                     NA)),
         college_before = college * beforeSummer) %>%
  filter(!is.na(beforeSummer))

# DD Reg
did_usable = lm(perc.usable ~ college + beforeSummer + college_before,
                data = did_pullman_seattle)
summary(did_usable)


did_totalitems = lm(tot_items ~ college + beforeSummer + college_before,
                data = did_pullman_seattle)
summary(did_totalitems)


did_perc.extracts = lm(perc.extracts ~ college + beforeSummer + college_before,
                data = did_pullman_seattle)
summary(did_perc.extracts)

did_perc.edible = lm(perc.edible ~ college + beforeSummer + college_before,
                data = did_pullman_seattle)
summary(did_perc.edible)



did_pullman_spokane <- daily_aggregate %>%
  filter(city=="PULLMAN" | city=="SPOKANE") %>%
  mutate(college = ifelse(city=="PULLMAN", 1, 0),
         beforeSummer = ifelse(saledate >= "2016-04-10" & saledate <= "2016-04-16", 1,
                              ifelse(saledate >= "2016-05-22" & saledate <= "2016-05-28", 0,
                                     NA)),
         college_before = college * beforeSummer) %>%
  filter(!is.na(beforeSummer))

# DD Reg
did_usable_spokane <- lm(perc.usable ~ college + beforeSummer + college_before,
                data = did_pullman_spokane)
summary(did_usable_spokane)


did_totalitemsspokane = lm(tot_items ~ college + beforeSummer + college_before,
                data = did_pullman_spokane)
summary(did_totalitemsspokane)


did_perc.extractsspokane = lm(perc.extracts ~ college + beforeSummer + college_before,
                data = did_pullman_spokane)
summary(did_perc.extractsspokane)

did_perc.ediblespokane = lm(perc.edible ~ college + beforeSummer + college_before,
                data = did_pullman_spokane)
summary(did_perc.ediblespokane)




```

```{r did_noncollege_vsPullman, echo=FALSE, message=FALSE, fig.width=6, fig.height=4.5}

names(daily_aggregate_PullmanNoncollege)

# daily_aggregate_PullmanNoncollege %>%
#   # dplyr::filter(!collegetown | city=="PULLMAN") %>%
#   # dplyr::group_by(collegetown, saledate) %>%
#   # dplyr::filter(saledate < "2017-01-01") %>%
#   dplyr::summarise(
#     revenue = sum(price_x, na.rm = T),
#     tot_items = length(retail_id),
#     avg_price_peritem = revenue / tot_items,
#     perc.usable = sum(inv_type_name == "Usable Marijuana") / tot_items,
#     perc.edible = sum(inv_type_name == "Liquid Marijuana Infused Edible" |
#                                      inv_type_name=="Solid Marijuana Infused Edible") / tot_items,
#     perc.extracts = sum(inv_type_name=="Marijuana Extract for Inhalation") / tot_items
#   ) %>%
#   filter(revenue >= 0)

# using all seven days
did_pullman_noncollege <- daily_aggregate_PullmanNoncollege %>%
  mutate(college = ifelse(collegetown, 1, 0),
         beforeSummer = ifelse(saledate >= "2016-04-10" & saledate <= "2016-04-16", 1,
                              ifelse(saledate >= "2016-05-22" & saledate <= "2016-05-28", 0,
                                     NA)),
         college_before = college * beforeSummer) %>%
  filter(!is.na(beforeSummer))

didnoncollege_perc.usable = lm(perc.usable ~ college + beforeSummer + college_before,
                data = did_pullman_noncollege)
summary(didnoncollege_perc.usable)

didnoncollege_perc.edible = lm(perc.edible ~ college + beforeSummer + college_before,
                data = did_pullman_noncollege)
summary(didnoncollege_perc.edible)

# percent usable
daily_aggregate_PullmanNoncollege %>%
  ggplot(aes(x=saledate, y=perc.usable)) +
  geom_point() +
  # different regression lines for spring, summer, and fall
  geom_smooth(data=subset(daily_aggregate_PullmanNoncollege,
                          saledate <= "2016-05-05"),
              mapping = aes(x=saledate,y=perc.usable),
              method = 'lm',color =  "#CC79A7") +
  geom_smooth(data=subset(daily_aggregate_PullmanNoncollege,
                          saledate >= "2016-05-05" & 
                            saledate <= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.usable), 
              method = 'lm', color =  "#CC79A7") +
  geom_smooth(data=subset(daily_aggregate_PullmanNoncollege,
                          saledate >= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.usable), 
              method = 'lm',color =  "#CC79A7") +
  # add lines to designate summer
  geom_vline(xintercept= as.numeric(as.Date('2016-5-6')),
             linetype="dashed", size=1, colour="darkgreen")+
  geom_vline(xintercept= as.numeric(as.Date('2016-8-22')),
             linetype="dashed", size=1, colour="darkgreen") +
  labs(title="Percent Usable") +
  facet_wrap("collegetown")

didnoncollege_perc.extracts = lm(perc.extracts ~ college + beforeSummer + college_before,
                data = did_pullman_noncollege)
summary(didnoncollege_perc.extracts)

# percent extract
daily_aggregate_PullmanNoncollege %>%
  ggplot(aes(x=saledate, y=perc.extracts)) +
  geom_point() +
  # different regression lines for spring, summer, and fall
  geom_smooth(data=subset(daily_aggregate_PullmanNoncollege,
                          saledate <= "2016-05-05"),
              mapping = aes(x=saledate,y=perc.extracts),
              method = 'lm',color =  "#CC79A7") +
  geom_smooth(data=subset(daily_aggregate_PullmanNoncollege,
                          saledate >= "2016-05-05" & 
                            saledate <= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.extracts), 
              method = 'lm', color =  "#CC79A7") +
  geom_smooth(data=subset(daily_aggregate_PullmanNoncollege,
                          saledate >= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.extracts), 
              method = 'lm',color =  "#CC79A7") +
  # add lines to designate summer
  geom_vline(xintercept= as.numeric(as.Date('2016-5-6')),
             linetype="dashed", size=1, colour="darkgreen")+
  geom_vline(xintercept= as.numeric(as.Date('2016-8-22')),
             linetype="dashed", size=1, colour="darkgreen") +
  labs(title="Percent Extracts") +
  facet_wrap("collegetown")

didnoncollege_perc.edible = lm(perc.edible ~ college + beforeSummer + college_before,
                data = did_pullman_noncollege)
summary(didnoncollege_perc.edible)


didnoncollege_perc.extracts = lm(perc.extracts ~ college + beforeSummer + college_before,
                data = did_pullman_noncollege)
summary(didnoncollege_perc.extracts)

# percent edible
daily_aggregate_PullmanNoncollege %>%
  ggplot(aes(x=saledate, y=perc.edible)) +
  geom_point() +
  # different regression lines for spring, summer, and fall
  geom_smooth(data=subset(daily_aggregate_PullmanNoncollege,
                          saledate <= "2016-05-05"),
              mapping = aes(x=saledate,y=perc.edible),
              method = 'lm',color =  "#CC79A7") +
  geom_smooth(data=subset(daily_aggregate_PullmanNoncollege,
                          saledate >= "2016-05-05" & 
                            saledate <= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.edible), 
              method = 'lm', color =  "#CC79A7") +
  geom_smooth(data=subset(daily_aggregate_PullmanNoncollege,
                          saledate >= "2016-08-22"),
              mapping = aes(x=saledate,y=perc.edible), 
              method = 'lm',color =  "#CC79A7") +
  # add lines to designate summer
  geom_vline(xintercept= as.numeric(as.Date('2016-5-6')),
             linetype="dashed", size=1, colour="darkgreen")+
  geom_vline(xintercept= as.numeric(as.Date('2016-8-22')),
             linetype="dashed", size=1, colour="darkgreen") +
  labs(title="Percent Edible") +
  facet_wrap("collegetown")

```


```{r did_noncollege_vsPullman_fallsem, echo=FALSE, message=FALSE, fig.width=6, fig.height=4.5}

did_pullman_noncollege_fallsem <- daily_aggregate_PullmanNoncollege %>%
  mutate(college = ifelse(collegetown, 1, 0),
         fallSemester = ifelse(saledate >= "2016-09-11" & saledate <= "2016-09-17", 1,
                              ifelse(saledate >= "2016-07-31" & saledate <= "2016-08-06", 0,
                                     NA)),
         college_fall = college * fallSemester) %>%
  filter(!is.na(fallSemester))


didnoncollegeFall_perc.usable = lm(perc.usable ~ college + fallSemester + college_fall,
                data = did_pullman_noncollege_fallsem)
summary(didnoncollegeFall_perc.usable)

didnoncollegeFall_perc.extracts = lm(perc.extracts ~ college + fallSemester + college_fall,
                data = did_pullman_noncollege_fallsem)
summary(didnoncollegeFall_perc.extracts)

didnoncollegeFall_perc.edible = lm(perc.edible ~ college + fallSemester + college_fall,
                data = did_pullman_noncollege_fallsem)
summary(didnoncollegeFall_perc.edible)

```



#### Noncollege, Non Urban

```{r noncollegenonurban}

did_pullman_noncollege_nonurban <- daily_aggregate_byTownType %>%
  filter(towntype_Pullman!="bigcity" & towntype_Pullman!="college") %>%
  mutate(college = ifelse(towntype_Pullman=="Pullman", 1, 0),
         beforeSummer = ifelse(saledate >= "2016-04-10" & saledate <= "2016-04-16", 1,
                              ifelse(saledate >= "2016-05-22" & saledate <= "2016-05-28", 0,
                                     NA)),
         college_before = college * beforeSummer) %>%
  filter(!is.na(beforeSummer))

# DD Reg
did_usable_noncollege_nonurban = lm(perc.usable ~ college + beforeSummer + college_before,
                data = did_pullman_noncollege_nonurban)
summary(did_usable_noncollege_nonurban)

did_edible_noncollege_nonurban = lm(perc.edible ~ college + beforeSummer + college_before,
                data = did_pullman_noncollege_nonurban)
summary(did_edible_noncollege_nonurban)

did_extracts_noncollege_nonurban = lm(perc.extracts ~ college + beforeSummer + college_before,
                data = did_pullman_noncollege_nonurban)
summary(did_extracts_noncollege_nonurban)

did_ppitem_noncollege_nonurban = lm(avg_price_peritem ~ college + beforeSummer + college_before,
                data = did_pullman_noncollege_nonurban)
summary(did_ppitem_noncollege_nonurban)

did_ppitem_noncollege_nonurban = lm(avg_price_peritem ~ college + beforeSummer + college_before,
                data = did_pullman_noncollege_nonurban)
summary(did_ppitem_noncollege_nonurban)


did_totItems_noncollege_nonurban = lm(tot_items ~ college + beforeSummer + college_before,
                data = did_pullman_noncollege_nonurban)
summary(did_totItems_noncollege_nonurban)

did_revenue_noncollege_nonurban = lm(revenue ~ college + beforeSummer + college_before,
                data = did_pullman_noncollege_nonurban)
summary(did_revenue_noncollege_nonurban)
```

#### Fall Semester

```{r fallsem}

did_fallsem_noncollege_nonurban <- daily_aggregate_byTownType %>%
  filter(towntype_Pullman!="bigcity" & towntype_Pullman!="college") %>%
  mutate(college = ifelse(towntype_Pullman=="Pullman", 1, 0),
         fallSemester = ifelse(saledate >= "2016-09-11" & saledate <= "2016-09-17", 1,
                              ifelse(saledate >= "2016-07-31" & saledate <= "2016-08-06", 0,
                                     NA)),
         college_fall = college * fallSemester) %>%
  filter(!is.na(fallSemester))

# DD Reg
didFall_usable_noncollege_nonurban = lm(perc.usable ~ college + fallSemester + college_fall,
                data = did_fallsem_noncollege_nonurban)
summary(didFall_usable_noncollege_nonurban)

didFall_edible_noncollege_nonurban = lm(perc.edible ~ college + fallSemester + college_fall,
                data = did_fallsem_noncollege_nonurban)
summary(didFall_edible_noncollege_nonurban)

didFall_extracts_noncollege_nonurban = lm(perc.extracts ~ college + fallSemester + college_fall,
                data = did_fallsem_noncollege_nonurban)
summary(didFall_extracts_noncollege_nonurban)

didFall_ppitem_noncollege_nonurban = lm(avg_price_peritem ~ college + fallSemester + college_fall,
                data = did_fallsem_noncollege_nonurban)
summary(didFall_ppitem_noncollege_nonurban)

didFall_totItems_noncollege_nonurban = lm(tot_items ~ college + fallSemester + college_fall,
                data = did_fallsem_noncollege_nonurban)
summary(didFall_totItems_noncollege_nonurban)

didFall_revenue_noncollege_nonurban = lm(revenue ~ college + fallSemester + college_fall,
                data = did_fallsem_noncollege_nonurban)
summary(didFall_revenue_noncollege_nonurban)
```

#### Noncollege, Non Urban

```{r noncollegenonurban2}

did_pullman_noncollege_nonurban <- daily_aggregate_byTownType %>%
  filter(towntype_Pullman!="bigcity" & towntype_Pullman!="college") %>%
  mutate(college = ifelse(towntype_Pullman=="Pullman", 1, 0),
         beforeSummer = ifelse(saledate >= "2016-04-10" & saledate <= "2016-04-16", 1,
                              ifelse(saledate >= "2016-05-22" & saledate <= "2016-05-28", 0,
                                     NA)),
         college_before = college * beforeSummer) %>%
  filter(!is.na(beforeSummer))

# DD Reg
did_usable_noncollege_nonurban = lm(perc.usable ~ college + beforeSummer + college_before,
                data = did_pullman_noncollege_nonurban)
summary(did_usable_noncollege_nonurban)

did_edible_noncollege_nonurban = lm(perc.edible ~ college + beforeSummer + college_before,
                data = did_pullman_noncollege_nonurban)
summary(did_edible_noncollege_nonurban)

did_extracts_noncollege_nonurban = lm(perc.extracts ~ college + beforeSummer + college_before,
                data = did_pullman_noncollege_nonurban)
summary(did_extracts_noncollege_nonurban)

did_ppitem_noncollege_nonurban = lm(avg_price_peritem ~ college + beforeSummer + college_before,
                data = did_pullman_noncollege_nonurban)
summary(did_ppitem_noncollege_nonurban)

did_ppitem_noncollege_nonurban = lm(avg_price_peritem ~ college + beforeSummer + college_before,
                data = did_pullman_noncollege_nonurban)
summary(did_ppitem_noncollege_nonurban)


did_totItems_noncollege_nonurban = lm(tot_items ~ college + beforeSummer + college_before,
                data = did_pullman_noncollege_nonurban)
summary(did_totItems_noncollege_nonurban)

did_revenue_noncollege_nonurban = lm(revenue ~ college + beforeSummer + college_before,
                data = did_pullman_noncollege_nonurban)
summary(did_revenue_noncollege_nonurban)
```
